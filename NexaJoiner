-- NEXA ROBLOX JOB MONITOR - FIXED VERSION
-- No function ordering errors

local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Configuration
local SERVER_URL = "http://localhost:8080"
local UPDATE_INTERVAL = 3
local PLACE_ID = game.PlaceId

-- Create ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "NexaJobMonitor"
screenGui.ResetOnSpawn = false
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
screenGui.IgnoreGuiInset = true
screenGui.Parent = playerGui

-- Main Frame
local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 420, 0, 550)
mainFrame.Position = UDim2.new(0.5, -210, 0.5, -275)
mainFrame.BackgroundColor3 = Color3.fromRGB(15, 20, 25)
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui

local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 12)
mainCorner.Parent = mainFrame

local mainStroke = Instance.new("UIStroke")
mainStroke.Color = Color3.fromRGB(0, 217, 255)
mainStroke.Thickness = 2
mainStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
mainStroke.Parent = mainFrame

-- Header
local header = Instance.new("Frame")
header.Name = "Header"
header.Size = UDim2.new(1, 0, 0, 70)
header.BackgroundColor3 = Color3.fromRGB(0, 217, 255)
header.BorderSizePixel = 0
header.Parent = mainFrame

local headerCorner = Instance.new("UICorner")
headerCorner.CornerRadius = UDim.new(0, 12)
headerCorner.Parent = header

local headerFix = Instance.new("Frame")
headerFix.Size = UDim2.new(1, 0, 0, 12)
headerFix.Position = UDim2.new(0, 0, 1, -12)
headerFix.BackgroundColor3 = Color3.fromRGB(0, 217, 255)
headerFix.BorderSizePixel = 0
headerFix.Parent = header

local title = Instance.new("TextLabel")
title.Size = UDim2.new(0.5, 0, 1, 0)
title.Position = UDim2.new(0, 20, 0, 0)
title.BackgroundTransparency = 1
title.Font = Enum.Font.GothamBold
title.Text = "NEXA"
title.TextColor3 = Color3.fromRGB(15, 20, 25)
title.TextSize = 28
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = header

local subtitle = Instance.new("TextLabel")
subtitle.Size = UDim2.new(0.5, 0, 0, 20)
subtitle.Position = UDim2.new(0, 20, 1, -25)
subtitle.BackgroundTransparency = 1
subtitle.Font = Enum.Font.Gotham
subtitle.Text = "Job Monitor"
subtitle.TextColor3 = Color3.fromRGB(15, 20, 25)
subtitle.TextSize = 12
subtitle.TextXAlignment = Enum.TextXAlignment.Left
subtitle.Parent = header

local statusIndicator = Instance.new("TextLabel")
statusIndicator.Name = "StatusIndicator"
statusIndicator.Size = UDim2.new(0, 110, 0, 32)
statusIndicator.Position = UDim2.new(1, -120, 0.5, -16)
statusIndicator.BackgroundColor3 = Color3.fromRGB(255, 68, 68)
statusIndicator.Font = Enum.Font.GothamBold
statusIndicator.Text = "OFFLINE"
statusIndicator.TextColor3 = Color3.fromRGB(255, 255, 255)
statusIndicator.TextSize = 13
statusIndicator.Parent = header

local statusCorner = Instance.new("UICorner")
statusCorner.CornerRadius = UDim.new(0, 8)
statusCorner.Parent = statusIndicator

local closeButton = Instance.new("TextButton")
closeButton.Size = UDim2.new(0, 35, 0, 35)
closeButton.Position = UDim2.new(1, -45, 0, 17.5)
closeButton.BackgroundColor3 = Color3.fromRGB(255, 68, 68)
closeButton.Font = Enum.Font.GothamBold
closeButton.Text = "X"
closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
closeButton.TextSize = 18
closeButton.Parent = mainFrame

local closeCorner = Instance.new("UICorner")
closeCorner.CornerRadius = UDim.new(0, 8)
closeCorner.Parent = closeButton

-- Job ID Section
local jobIdFrame = Instance.new("Frame")
jobIdFrame.Size = UDim2.new(1, -30, 0, 90)
jobIdFrame.Position = UDim2.new(0, 15, 0, 85)
jobIdFrame.BackgroundColor3 = Color3.fromRGB(26, 31, 38)
jobIdFrame.BorderSizePixel = 0
jobIdFrame.Parent = mainFrame

local jobIdCorner = Instance.new("UICorner")
jobIdCorner.CornerRadius = UDim.new(0, 10)
jobIdCorner.Parent = jobIdFrame

local jobIdLabel = Instance.new("TextLabel")
jobIdLabel.Size = UDim2.new(1, -20, 0, 28)
jobIdLabel.Position = UDim2.new(0, 12, 0, 8)
jobIdLabel.BackgroundTransparency = 1
jobIdLabel.Font = Enum.Font.GothamBold
jobIdLabel.Text = "üîë JOB ID (Auto-Join)"
jobIdLabel.TextColor3 = Color3.fromRGB(0, 217, 255)
jobIdLabel.TextSize = 13
jobIdLabel.TextXAlignment = Enum.TextXAlignment.Left
jobIdLabel.Parent = jobIdFrame

local jobIdInput = Instance.new("TextBox")
jobIdInput.Size = UDim2.new(1, -24, 0, 38)
jobIdInput.Position = UDim2.new(0, 12, 0, 42)
jobIdInput.BackgroundColor3 = Color3.fromRGB(15, 20, 25)
jobIdInput.Font = Enum.Font.Gotham
jobIdInput.PlaceholderText = "Waiting for job..."
jobIdInput.PlaceholderColor3 = Color3.fromRGB(120, 120, 120)
jobIdInput.Text = ""
jobIdInput.TextColor3 = Color3.fromRGB(255, 255, 255)
jobIdInput.TextSize = 14
jobIdInput.ClearTextOnFocus = false
jobIdInput.TextXAlignment = Enum.TextXAlignment.Left
jobIdInput.TextTruncate = Enum.TextTruncate.None
jobIdInput.TextWrapped = false
jobIdInput.ClipsDescendants = true
jobIdInput.Parent = jobIdFrame

local inputCorner = Instance.new("UICorner")
inputCorner.CornerRadius = UDim.new(0, 8)
inputCorner.Parent = jobIdInput

local inputPadding = Instance.new("UIPadding")
inputPadding.PaddingLeft = UDim.new(0, 8)
inputPadding.PaddingRight = UDim.new(0, 8)
inputPadding.Parent = jobIdInput

-- Jobs List
local jobsLabel = Instance.new("TextLabel")
jobsLabel.Size = UDim2.new(1, -30, 0, 28)
jobsLabel.Position = UDim2.new(0, 15, 0, 185)
jobsLabel.BackgroundTransparency = 1
jobsLabel.Font = Enum.Font.GothamBold
jobsLabel.Text = "üìã RECENT JOBS"
jobsLabel.TextColor3 = Color3.fromRGB(0, 217, 255)
jobsLabel.TextSize = 14
jobsLabel.TextXAlignment = Enum.TextXAlignment.Left
jobsLabel.Parent = mainFrame

local scrollFrame = Instance.new("ScrollingFrame")
scrollFrame.Size = UDim2.new(1, -30, 1, -230)
scrollFrame.Position = UDim2.new(0, 15, 0, 218)
scrollFrame.BackgroundColor3 = Color3.fromRGB(26, 31, 38)
scrollFrame.BorderSizePixel = 0
scrollFrame.ScrollBarThickness = 8
scrollFrame.ScrollBarImageColor3 = Color3.fromRGB(0, 217, 255)
scrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
scrollFrame.Parent = mainFrame

local scrollCorner = Instance.new("UICorner")
scrollCorner.CornerRadius = UDim.new(0, 10)
scrollCorner.Parent = scrollFrame

local listLayout = Instance.new("UIListLayout")
listLayout.SortOrder = Enum.SortOrder.LayoutOrder
listLayout.Padding = UDim.new(0, 10)
listLayout.Parent = scrollFrame

local listPadding = Instance.new("UIPadding")
listPadding.PaddingTop = UDim.new(0, 8)
listPadding.PaddingBottom = UDim.new(0, 8)
listPadding.PaddingLeft = UDim.new(0, 8)
listPadding.PaddingRight = UDim.new(0, 8)
listPadding.Parent = scrollFrame

-- Variables
local isConnected = false
local lastJobId = nil
local connectionAttempts = 0
local joining = false

-- Notification system
local function showNotification(text, color)
	local notif = Instance.new("TextLabel")
	notif.Size = UDim2.new(0, 300, 0, 50)
	notif.Position = UDim2.new(0.5, -150, 0, -60)
	notif.BackgroundColor3 = color
	notif.Font = Enum.Font.GothamBold
	notif.Text = text
	notif.TextColor3 = Color3.fromRGB(255, 255, 255)
	notif.TextSize = 14
	notif.Parent = screenGui
	
	local notifCorner = Instance.new("UICorner")
	notifCorner.CornerRadius = UDim.new(0, 10)
	notifCorner.Parent = notif
	
	notif:TweenPosition(UDim2.new(0.5, -150, 0, 20), "Out", "Back", 0.5, true)
	task.wait(3)
	notif:TweenPosition(UDim2.new(0.5, -150, 0, -60), "In", "Back", 0.3, true)
	task.wait(0.3)
	notif:Destroy()
end

local function updateConnectionStatus(connected)
	isConnected = connected
	if connected then
		statusIndicator.Text = "‚úì ONLINE"
		statusIndicator.BackgroundColor3 = Color3.fromRGB(0, 255, 136)
		connectionAttempts = 0
	else
		statusIndicator.Text = "‚úó OFFLINE"
		statusIndicator.BackgroundColor3 = Color3.fromRGB(255, 68, 68)
	end
end

local function createJobCard(jobData)
	local card = Instance.new("TextButton")
	card.Size = UDim2.new(1, -16, 0, 75)
	card.BackgroundColor3 = Color3.fromRGB(15, 20, 25)
	card.BorderSizePixel = 0
	card.AutoButtonColor = false
	card.Text = ""
	
	local cardCorner = Instance.new("UICorner")
	cardCorner.CornerRadius = UDim.new(0, 8)
	cardCorner.Parent = card
	
	local cardStroke = Instance.new("UIStroke")
	cardStroke.Color = Color3.fromRGB(0, 217, 255)
	cardStroke.Thickness = 1
	cardStroke.Transparency = 0.7
	cardStroke.Parent = card
	
	local nameLabel = Instance.new("TextLabel")
	nameLabel.Size = UDim2.new(1, -16, 0, 22)
	nameLabel.Position = UDim2.new(0, 8, 0, 6)
	nameLabel.BackgroundTransparency = 1
	nameLabel.Font = Enum.Font.GothamBold
	nameLabel.Text = jobData.name or "Unknown Job"
	nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	nameLabel.TextSize = 13
	nameLabel.TextXAlignment = Enum.TextXAlignment.Left
	nameLabel.TextTruncate = Enum.TextTruncate.AtEnd
	nameLabel.Parent = card
	
	local moneyLabel = Instance.new("TextLabel")
	moneyLabel.Size = UDim2.new(0.5, -10, 0, 20)
	moneyLabel.Position = UDim2.new(0, 8, 0, 30)
	moneyLabel.BackgroundTransparency = 1
	moneyLabel.Font = Enum.Font.Gotham
	moneyLabel.Text = "üí∞ " .. (jobData.money or "$0")
	moneyLabel.TextColor3 = Color3.fromRGB(0, 255, 136)
	moneyLabel.TextSize = 12
	moneyLabel.TextXAlignment = Enum.TextXAlignment.Left
	moneyLabel.Parent = card
	
	local playersLabel = Instance.new("TextLabel")
	playersLabel.Size = UDim2.new(0.5, -10, 0, 20)
	playersLabel.Position = UDim2.new(0.5, 0, 0, 30)
	playersLabel.BackgroundTransparency = 1
	playersLabel.Font = Enum.Font.Gotham
	playersLabel.Text = "üë• " .. (jobData.players or "0") .. "/8"
	playersLabel.TextColor3 = Color3.fromRGB(255, 211, 61)
	playersLabel.TextSize = 12
	playersLabel.TextXAlignment = Enum.TextXAlignment.Left
	playersLabel.Parent = card
	
	local idLabel = Instance.new("TextLabel")
	idLabel.Size = UDim2.new(1, -16, 0, 16)
	idLabel.Position = UDim2.new(0, 8, 1, -20)
	idLabel.BackgroundTransparency = 1
	idLabel.Font = Enum.Font.Gotham
	idLabel.Text = "ID: " .. (jobData.jobId or "N/A")
	idLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
	idLabel.TextSize = 10
	idLabel.TextXAlignment = Enum.TextXAlignment.Left
	idLabel.Parent = card
	
	-- Click to fill job ID and auto-join
	card.MouseButton1Click:Connect(function()
		if jobData.jobId then
			jobIdInput.Text = jobData.jobId
			showNotification("üìã Selected: " .. jobData.name, Color3.fromRGB(0, 217, 255))
			
			-- Flash card
			card.BackgroundColor3 = Color3.fromRGB(0, 217, 255)
			task.wait(0.2)
			card.BackgroundColor3 = Color3.fromRGB(15, 20, 25)
			
			-- Auto-join after selecting
			task.delay(0.5, function()
				attemptJoin()
			end)
		end
	end)
	
	-- Hover effect
	card.MouseEnter:Connect(function()
		cardStroke.Transparency = 0.3
	end)
	
	card.MouseLeave:Connect(function()
		cardStroke.Transparency = 0.7
	end)
	
	return card
end

local function updateJobsList(jobs)
	for _, child in ipairs(scrollFrame:GetChildren()) do
		if child:IsA("TextButton") then
			child:Destroy()
		end
	end
	
	for i, job in ipairs(jobs) do
		local card = createJobCard(job)
		card.LayoutOrder = i
		card.Parent = scrollFrame
	end
	
	task.wait(0.1)
	scrollFrame.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y + 16)
end

-- ATTEMPT JOIN FUNCTION - Defined early so it can be called by auto-join
local function attemptJoin()
	if joining then 
		print("NEXA: Already joining, please wait...")
		return 
	end
	
	local jobId = jobIdInput.Text
	jobId = string.gsub(jobId, "^%s*(.-)%s*$", "%1")
	
	if jobId == "" or jobId == "Waiting for job..." then
		return
	end
	
	joining = true
	
	print("NEXA: Attempting to join server...")
	print("Place ID:", PLACE_ID)
	print("Job ID:", jobId)
	
	local success, errorMsg = pcall(function()
		TeleportService:TeleportToPlaceInstance(PLACE_ID, jobId, player)
	end)
	
	if not success then
		local errorDisplay = "Failed to join"
		if string.find(tostring(errorMsg), "not found") then
			errorDisplay = "Server not found"
		elseif string.find(tostring(errorMsg), "full") then
			errorDisplay = "Server full"
		elseif string.find(tostring(errorMsg), "Invalid") then
			errorDisplay = "Invalid Job ID"
		end
		
		showNotification("‚ùå " .. errorDisplay, Color3.fromRGB(255, 68, 68))
		print("NEXA: Join failed -", errorMsg)
		task.wait(2)
		joining = false
	else
		print("NEXA: Teleporting...")
		-- Will teleport, reset after delay in case it fails
		task.delay(3, function()
			joining = false
		end)
	end
end

-- FETCH JOBS FUNCTION - Now attemptJoin is already defined
local function fetchJobs()
	local success, result = pcall(function()
		return game:HttpGet(SERVER_URL .. "/jobs", true)
	end)
	
	if success and result then
		local decodeSuccess, data = pcall(function()
			return HttpService:JSONDecode(result)
		end)
		
		if decodeSuccess and data then
			updateConnectionStatus(data.connected or false)
			
			if data.jobs and #data.jobs > 0 then
				updateJobsList(data.jobs)
				
				local latestJob = data.jobs[1]
				if latestJob and latestJob.jobId and latestJob.jobId ~= lastJobId then
					lastJobId = latestJob.jobId
					jobIdInput.Text = latestJob.jobId
					
					local originalColor = jobIdInput.BackgroundColor3
					jobIdInput.BackgroundColor3 = Color3.fromRGB(0, 255, 136)
					task.spawn(function()
						showNotification("üî• New Job: " .. latestJob.name, Color3.fromRGB(0, 217, 255))
					end)
					task.wait(0.5)
					jobIdInput.BackgroundColor3 = originalColor
					
					-- AUTO-JOIN after visual feedback
					task.delay(0.3, function()
						attemptJoin()
					end)
				end
			end
			
			connectionAttempts = 0
		else
			warn("Failed to decode JSON response")
			updateConnectionStatus(false)
		end
	else
		connectionAttempts = connectionAttempts + 1
		updateConnectionStatus(false)
		
		if connectionAttempts == 1 then
			warn("NEXA: Cannot connect to desktop server")
			warn("Make sure nexa_monitor_server.py is running!")
		end
	end
end

-- Event Handlers
closeButton.MouseButton1Click:Connect(function()
	screenGui:Destroy()
end)

-- Press Enter to manually trigger join
jobIdInput.FocusLost:Connect(function(enterPressed)
	if enterPressed and jobIdInput.Text ~= "" then
		attemptJoin()
	end
end)

-- Main Update Loop
task.spawn(function()
	showNotification("üöÄ NEXA Monitor Starting...", Color3.fromRGB(0, 217, 255))
	task.wait(1)
	
	while screenGui and screenGui.Parent do
		fetchJobs()
		task.wait(UPDATE_INTERVAL)
	end
end)

fetchJobs()

print("‚úÖ NEXA Job Monitor loaded successfully!")
print("üåê Connecting to desktop server at:", SERVER_URL)




