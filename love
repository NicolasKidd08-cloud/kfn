--[[
    Nexa Hub v1.0 (Modern Green Edition)
    Redesigned with sleek green theme and modern aesthetics
    Structure: Config -> Services -> Helpers -> Features -> GUI -> Init
]]

-- ============================================================
-- SECTION 1: CONFIGURATION
-- ============================================================

getgenv().NEXA_CONFIG = {
    -- Keybinds
    TELEPORT_KEYBIND       = nil,
    TOGGLE_GUI_KEYBIND     = nil,
    INSTANT_CLONER_KEYBIND = nil,
    KICK_SELF_KEYBIND      = nil,
    FLOOR_STEAL_KEYBIND    = nil,
    REJOIN_KEYBIND         = nil,
    DESYNC_KEYBIND         = nil,

    -- Main Features
    AUTO_TP_ENABLED        = false,
    AUTO_HIDE_ENABLED      = false,
    AUTO_STEAL_ENABLED     = false,
    AUTO_STEAL_NEAREST_ENABLED = false,
    AUTO_STEAL_PRIORITY_ENABLED = false,
    PREDICTIVE_STEAL       = true,
    OptimizerEnabled       = false,
    FLOOR_STEAL_ENABLED    = false,
    AUTO_DESYNC_ENABLED    = false,
    STEAL_SPEED_ENABLED    = false,
    STEAL_DISABLE_ANIM_ENABLED = false,

    GUI_POSITION_X = nil,
    GUI_POSITION_Y = nil,
    MINI_GUI_POSITION_X = nil,
    MINI_GUI_POSITION_Y = nil,
    
    -- Filters
    SHOW_ALL_RARITIES      = true,
    SHOW_MUTATIONS_ONLY    = false,
    SHOW_TRAITS_ONLY       = false,
    MIN_GEN_VALUE          = 0,
    
    -- Priority System
    FAVORITES_PRIORITY_ENABLED = false,
    INVISIBLE_BASE_WALLS_ENABLED = false,
    SAFE_TELEPORT  = true,
    CARPET_MIDDLE  = false,
    
    -- ESP
    ESP_ENABLED         = false,
    ESP_PLAYERS_ENABLED = false,
    
    -- Anti-Lag
    ANTI_LAG_ENABLED    = false,
    ANTI_BEE_DISCO_ENABLED = false,
    ANTI_RAGDOLL_V1_ENABLED = false,
    ANTI_RAGDOLL_V2_ENABLED = false,
}

local PRIORITY_ANIMALS = {
    "Strawberry Elephant",
    "Meowl",
    "Headless Horseman",
    "Dragon Cannelloni",
    "Capitano Moby",
    "Cooki and Milki",
    "La Supreme Combinasion",
    "Burguro and Fryuro",
    "Garama and Madundung",
    "Lavadorito Spinito",
    "Spooky and Pumpky",
    "La Casa Boo",
    "La Secret Combinasion",
    "Chillin Chili",
    "Ketchuru and Musturu",
    "Ketupat Kepat",
    "La Taco Combinasion",
    "Tang Tang Keletang",
    "Tictac Sahur",
    "W or L",
    "Spaghetti Tualetti",
    "Nuclearo Dinossauro",
    "Money Money Puggy"
}

local CONFIG = getgenv().NEXA_CONFIG

if not getgenv().NEXA_FAVORITES then
    getgenv().NEXA_FAVORITES = {}
end

local FAVORITES = getgenv().NEXA_FAVORITES

local Config = {
    FAVORITES_FILE = "NexaHubFavorites.json",
    CONFIG_FILE_NAME = "NexaHubConfig.json"
}

-- MODERN GREEN COLOR SCHEME
local COLORS = {
    -- Base colors
    Background             = Color3.fromRGB(10, 15, 12),
    BackgroundTransparency = 0.15,
    Surface                = Color3.fromRGB(15, 25, 18),
    SurfaceTransparency    = 0.20,
    
    -- Text colors
    Text    = Color3.fromRGB(240, 255, 245),
    TextDim = Color3.fromRGB(180, 200, 185),
    
    -- Primary green accent
    Primary = Color3.fromRGB(0, 255, 157),  -- Bright neon green
    Accent  = Color3.fromRGB(0, 255, 157),
    
    -- Secondary colors
    Green   = Color3.fromRGB(0, 255, 157),
    DarkGreen = Color3.fromRGB(0, 180, 110),
    Cyan    = Color3.fromRGB(0, 255, 200),
    Teal    = Color3.fromRGB(0, 200, 180),
    
    -- Status colors
    Success = Color3.fromRGB(0, 255, 157),
    Warning = Color3.fromRGB(255, 200, 0),
    Error   = Color3.fromRGB(255, 80, 100),
    
    -- Shadow/glow
    Glow    = Color3.fromRGB(0, 255, 157),
}

-- Desync flags (keeping original functionality)
local DESYNC_FLAGS = {
    LargeReplicatorEnabled9 = true,
    GameNetDontSendRedundantNumTimes = 1,
    MaxTimestepMultiplierAcceleration = 2147483647,
    InterpolationFrameVelocityThresholdMillionth = 5,
    CheckPVDifferencesForInterpolationMinRotVelThresholdRadsPerSecHundredth = 1,
    TimestepArbiterVelocityCriteriaThresholdTwoDt = 2147483646,
    GameNetPVHeaderLinearVelocityZeroCutoffExponent = -5000,
    TimestepArbiterHumanoidTurningVelThreshold = 1,
    LargeReplicatorSerializeWrite4 = true,
    SimExplicitlyCappedTimestepMultiplier = 2147483646,
    InterpolationFrameRotVelocityThresholdMillionth = 5,
    ServerMaxBandwith = 52,
    LargeReplicatorSerializeRead3 = true,
    GameNetDontSendRedundantDeltaPositionMillionth = 1,
    PhysicsSenderMaxBandwidthBps = 20000,
    CheckPVCachedVelThresholdPercent = 10,
    NextGenReplicatorEnabledWrite4 = true,
    LargeReplicatorWrite5 = true,
    MaxMissedWorldStepsRemembered = -2147483648,
    StreamJobNOUVolumeCap = 2147483647,
    CheckPVLinearVelocityIntegrateVsDeltaPositionThresholdPercent = 1,
    DisableDPIScale = true,
    WorldStepMax = 30,
    InterpolationFramePositionThresholdMillionth = 5,
    MaxAcceptableUpdateDelay = 1,
    TimestepArbiterOmegaThou = 1073741823,
    CheckPVCachedRotVelThresholdPercent = 10,
    StreamJobNOUVolumeLengthCap = 2147483647,
    S2PhysicsSenderRate = 15000,
    MaxTimestepMultiplierBuoyancy = 2147483647,
    SimOwnedNOUCountThresholdMillionth = 2147483647,
    ReplicationFocusNouExtentsSizeCutoffForPauseStuds = 2147483647,
    LargeReplicatorRead5 = true,
    CheckPVDifferencesForInterpolationMinVelThresholdStudsPerSecHundredth = 1,
    MaxDataPacketPerSend = 2147483647,
    MaxTimestepMultiplierContstraint = 2147483647,
    DebugSendDistInSteps = -2147483648,
    GameNetPVHeaderRotationalVelocityZeroCutoffExponent = -5000,
    AngularVelociryLimit = 360
}

-- ============================================================
-- SECTION 2: SERVICES & MODULES
-- ============================================================

local S = {
    Players           = game:GetService("Players"),
    UserInputService  = game:GetService("UserInputService"),
    TweenService      = game:GetService("TweenService"),
    ReplicatedStorage = game:GetService("ReplicatedStorage"),
    HttpService       = game:GetService("HttpService"),
    RunService        = game:GetService("RunService"),
    Stats             = game:GetService("Stats"),
    TeleportService   = game:GetService("TeleportService"),
    Lighting          = game:GetService("Lighting"),
}

S.Packages = S.ReplicatedStorage:WaitForChild("Packages")
S.Datas    = S.ReplicatedStorage:WaitForChild("Datas")
S.Shared   = S.ReplicatedStorage:WaitForChild("Shared")
S.Utils    = S.ReplicatedStorage:WaitForChild("Utils")

S.Synchronizer  = require(S.Packages:WaitForChild("Synchronizer"))
S.AnimalsData   = require(S.Datas:WaitForChild("Animals"))
S.RaritiesData  = require(S.Datas:WaitForChild("Rarities"))
S.AnimalsShared = require(S.Shared:WaitForChild("Animals"))
S.NumberUtils   = require(S.Utils:WaitForChild("NumberUtils"))

S.LocalPlayer = S.Players.LocalPlayer
S.PlayerGui   = S.LocalPlayer:WaitForChild("PlayerGui")

-- ============================================================
-- SECTION 3: GLOBAL STATE
-- ============================================================

local screenGui, mainFrame, contentFrame
local allAnimalsCache = {}
local guiVisible = true
local currentTab = "animals"
local searchQuery = ""
local isCloning = false
local highestAnimal = nil
local statLabels = nil

local ESP_INSTANCES = {}
local PLAYER_ESP = {}
local ESP_BEST_UID = nil

local stats = {
    totalAnimals  = 0,
    totalValue    = 0,
    highestGen    = 0,
    mutationCount = 0,
    traitCount    = 0,
}

local scannerConnections = {}
local plotChannels = {}
local lastAnimalData = {}

local floatPlatform = nil
local invisibleWallsLoaded = false
local originalTransparency = {}

local InternalStealCache = {}
local AUTO_STEAL_PROX_RADIUS = 20
local PromptMemoryCache = {}
local LastTargetUID = nil
local LastPlayerPosition = nil
local PlayerVelocity = Vector3.zero
local PREDICTION_LOOKAHEAD = 1.25

local STEAL_SPEED = 25.5
local stealSpeedConn = nil

local PLAYER_OUTLINE_MAIN = COLORS.Green
local PLAYER_OUTLINE_SOFT = COLORS.Teal

local tweenInfoFast   = TweenInfo.new(0.2, Enum.EasingStyle.Cubic, Enum.EasingDirection.Out)
local tweenInfoMedium = TweenInfo.new(0.4, Enum.EasingStyle.Cubic, Enum.EasingDirection.Out)

-- ============================================================
-- SECTION 4: HELPER FUNCTIONS
-- ============================================================

local function blendColor(c1, c2, alpha)
    return Color3.new(
        c1.R + (c2.R - c1.R) * alpha,
        c1.G + (c2.G - c1.G) * alpha,
        c1.B + (c2.B - c1.B) * alpha
    )
end

local function createElement(className, properties)
    local el = Instance.new(className)
    for k, v in pairs(properties) do
        el[k] = v
    end
    return el
end

local function tween(el, info, props)
    S.TweenService:Create(el, info, props):Play()
end

-- Add modern green glow effect
local function addGreenGlow(element)
    local glow = createElement("UIStroke", {
        Color = COLORS.Glow,
        Thickness = 0,
        Transparency = 0.5,
        ApplyStrokeMode = Enum.ApplyStrokeMode.Border,
        Parent = element,
    })
    
    -- Animated glow pulse
    task.spawn(function()
        while element.Parent and glow.Parent do
            tween(glow, TweenInfo.new(1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), {
                Thickness = 2,
                Transparency = 0.3
            })
            task.wait(1.5)
            tween(glow, TweenInfo.new(1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), {
                Thickness = 0,
                Transparency = 0.7
            })
            task.wait(1.5)
        end
    end)
    
    return glow
end

-- ============================================================
-- NOTIFICATION SYSTEM (Modern Green Theme)
-- ============================================================

local NOTIFICATION_QUEUE = {}
local NOTIFICATION_ACTIVE = {}
local MAX_NOTIFICATIONS = 5
local NOTIFICATION_DURATION = 3.5

function showNotification(message, color, duration)
    if not screenGui then return end
    
    duration = duration or NOTIFICATION_DURATION
    color = color or COLORS.Green
    
    if #NOTIFICATION_ACTIVE >= MAX_NOTIFICATIONS then
        table.insert(NOTIFICATION_QUEUE, {message = message, color = color, duration = duration})
        return
    end
    
    local notif = {}
    
    notif.frame = createElement("Frame", {
        Size = UDim2.new(0, 340, 0, 70),
        Position = UDim2.new(1, 400, 1, -80 - (#NOTIFICATION_ACTIVE * 80)),
        BackgroundColor3 = COLORS.Surface,
        BackgroundTransparency = 0.1,
        BorderSizePixel = 0,
        Parent = screenGui,
        ZIndex = 999999,
    })
    
    createElement("UICorner", {
        CornerRadius = UDim.new(0, 12),
        Parent = notif.frame,
    })
    
    local border = createElement("UIStroke", {
        Color = color,
        Thickness = 2,
        Transparency = 0.3,
        ApplyStrokeMode = Enum.ApplyStrokeMode.Border,
        Parent = notif.frame,
    })
    
    local accentBar = createElement("Frame", {
        Size = UDim2.new(0, 4, 1, 0),
        BackgroundColor3 = color,
        BorderSizePixel = 0,
        Parent = notif.frame,
    })
    
    createElement("UICorner", {
        CornerRadius = UDim.new(1, 0),
        Parent = accentBar,
    })
    
    local messageLabel = createElement("TextLabel", {
        Size = UDim2.new(1, -50, 1, 0),
        Position = UDim2.new(0, 20, 0, 0),
        BackgroundTransparency = 1,
        Text = message,
        TextColor3 = COLORS.Text,
        TextSize = 14,
        Font = Enum.Font.GothamSemibold,
        TextWrapped = true,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextYAlignment = Enum.TextYAlignment.Center,
        Parent = notif.frame,
    })
    
    local closeButton = createElement("TextButton", {
        Size = UDim2.new(0, 30, 0, 30),
        Position = UDim2.new(1, -35, 0.5, -15),
        BackgroundTransparency = 1,
        Text = "√ó",
        TextColor3 = COLORS.TextDim,
        TextSize = 20,
        Font = Enum.Font.GothamBold,
        Parent = notif.frame,
    })
    
    closeButton.MouseButton1Click:Connect(function()
        notif.frame:Destroy()
        for i, n in ipairs(NOTIFICATION_ACTIVE) do
            if n == notif then
                table.remove(NOTIFICATION_ACTIVE, i)
                break
            end
        end
    end)
    
    table.insert(NOTIFICATION_ACTIVE, notif)
    
    tween(notif.frame, tweenInfoMedium, {
        Position = UDim2.new(1, -350, 1, -80 - ((#NOTIFICATION_ACTIVE - 1) * 80))
    })
    
    task.delay(duration, function()
        if notif.frame then
            tween(notif.frame, tweenInfoMedium, {
                Position = UDim2.new(1, 400, notif.frame.Position.Y.Scale, notif.frame.Position.Y.Offset)
            })
            task.wait(0.5)
            notif.frame:Destroy()
            for i, n in ipairs(NOTIFICATION_ACTIVE) do
                if n == notif then
                    table.remove(NOTIFICATION_ACTIVE, i)
                    break
                end
            end
        end
    end)
end

getgenv().ShowNotification = showNotification

-- ============================================================
-- CONFIG MANAGEMENT
-- ============================================================

local function saveConfig()
    local serializableConfig = {}
    for k, v in pairs(CONFIG) do
        if typeof(v) == "EnumItem" then
            serializableConfig[k] = {_type = "EnumItem", _enumType = tostring(v.EnumType), _name = v.Name}
        else
            serializableConfig[k] = v
        end
    end
    local success, jsonData = pcall(S.HttpService.JSONEncode, S.HttpService, serializableConfig)
    if success then
        writefile(Config.CONFIG_FILE_NAME, jsonData)
    end
end

local function loadConfig()
    if not isfile(Config.CONFIG_FILE_NAME) then return end
    local success, jsonData = pcall(readfile, Config.CONFIG_FILE_NAME)
    if not success then return end
    local success2, savedConfig = pcall(S.HttpService.JSONDecode, S.HttpService, jsonData)
    if not success2 then return end
    for k, v in pairs(savedConfig) do
        if type(v) == "table" and v._type == "EnumItem" then
            if v._enumType == "KeyCode" and Enum.KeyCode[v._name] then
                CONFIG[k] = Enum.KeyCode[v._name]
            end
        else
            CONFIG[k] = v
        end
    end
    getgenv().NEXA_CONFIG = CONFIG
end

local function saveGuiPosition()
    if not mainFrame then return end
    local pos = mainFrame.AbsolutePosition
    CONFIG.GUI_POSITION_X = pos.X
    CONFIG.GUI_POSITION_Y = pos.Y
    saveConfig()
end

local miniGuiContainer = nil

local function saveMiniGuiPosition()
    if not miniGuiContainer then return end
    local pos = miniGuiContainer.AbsolutePosition
    CONFIG.MINI_GUI_POSITION_X = pos.X
    CONFIG.MINI_GUI_POSITION_Y = pos.Y
    saveConfig()
end

-- [REST OF THE ORIGINAL SCRIPT FUNCTIONS - keeping all functionality but updating UI colors]
-- I'll continue with the key UI creation functions with the new green theme...

-- ============================================================
-- MODERN TOGGLE COMPONENT (Green Theme)
-- ============================================================

local function createModernToggle(parent, text, configKey, callback, order)
    local container = createElement("Frame", {
        Size = UDim2.new(1, -20, 0, 45),
        Position = UDim2.new(0, 10, 0, 0),
        BackgroundColor3 = COLORS.Surface,
        BackgroundTransparency = 0.3,
        BorderSizePixel = 0,
        LayoutOrder = order or 0,
        Parent = parent,
    })
    
    createElement("UICorner", {
        CornerRadius = UDim.new(0, 8),
        Parent = container,
    })
    
    -- Modern green border
    local border = createElement("UIStroke", {
        Color = COLORS.Green,
        Thickness = 1,
        Transparency = 0.7,
        ApplyStrokeMode = Enum.ApplyStrokeMode.Border,
        Parent = container,
    })
    
    local label = createElement("TextLabel", {
        Size = UDim2.new(0.65, 0, 1, 0),
        Position = UDim2.new(0, 15, 0, 0),
        BackgroundTransparency = 1,
        Text = text,
        TextColor3 = COLORS.Text,
        TextSize = 13,
        Font = Enum.Font.GothamSemibold,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = container,
    })
    
    local isEnabled = CONFIG[configKey] or false
    
    -- Modern toggle switch
    local toggleBg = createElement("Frame", {
        Size = UDim2.new(0, 48, 0, 24),
        Position = UDim2.new(1, -58, 0.5, -12),
        BackgroundColor3 = isEnabled and COLORS.Green or Color3.fromRGB(40, 45, 42),
        BackgroundTransparency = 0.2,
        BorderSizePixel = 0,
        Parent = container,
    })
    
    createElement("UICorner", {
        CornerRadius = UDim.new(1, 0),
        Parent = toggleBg,
    })
    
    local toggleCircle = createElement("Frame", {
        Size = UDim2.new(0, 18, 0, 18),
        Position = isEnabled and UDim2.new(0, 27, 0.5, -9) or UDim2.new(0, 3, 0.5, -9),
        BackgroundColor3 = Color3.fromRGB(255, 255, 255),
        BorderSizePixel = 0,
        Parent = toggleBg,
    })
    
    createElement("UICorner", {
        CornerRadius = UDim.new(1, 0),
        Parent = toggleCircle,
    })
    
    -- Add subtle glow to enabled toggles
    if isEnabled then
        addGreenGlow(toggleBg)
    end
    
    local button = createElement("TextButton", {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Text = "",
        Parent = container,
    })
    
    button.MouseButton1Click:Connect(function()
        isEnabled = not isEnabled
        CONFIG[configKey] = isEnabled
        
        tween(toggleBg, tweenInfoFast, {
            BackgroundColor3 = isEnabled and COLORS.Green or Color3.fromRGB(40, 45, 42)
        })
        
        tween(toggleCircle, tweenInfoMedium, {
            Position = isEnabled and UDim2.new(0, 27, 0.5, -9) or UDim2.new(0, 3, 0.5, -9)
        })
        
        tween(border, tweenInfoFast, {
            Transparency = isEnabled and 0.3 or 0.7
        })
        
        if callback then callback(isEnabled) end
        saveConfig()
    end)
    
    container.MouseEnter:Connect(function()
        tween(border, tweenInfoFast, {Transparency = 0.3})
    end)
    
    container.MouseLeave:Connect(function()
        if not isEnabled then
            tween(border, tweenInfoFast, {Transparency = 0.7})
        end
    end)
    
    return container
end

-- ============================================================
-- FAVORITES MANAGEMENT (Full Integration)
-- ============================================================

local function saveFavorites()
    local success, jsonData = pcall(S.HttpService.JSONEncode, S.HttpService, FAVORITES)
    if success then
        writefile(Config.FAVORITES_FILE, jsonData)
    end
end

local function loadFavorites()
    if not isfile(Config.FAVORITES_FILE) then return end
    local success, jsonData = pcall(readfile, Config.FAVORITES_FILE)
    if not success then return end
    local success2, savedFavorites = pcall(S.HttpService.JSONDecode, S.HttpService, jsonData)
    if success2 and savedFavorites then
        for _, name in ipairs(savedFavorites) do
            table.insert(FAVORITES, name)
        end
        getgenv().NEXA_FAVORITES = FAVORITES
    end
end

local function isFavorite(animalName)
    for _, name in ipairs(FAVORITES) do
        if name:lower() == animalName:lower() then
            return true
        end
    end
    return false
end

local function addFavorite(animalName)
    for _, name in ipairs(FAVORITES) do
        if name:lower() == animalName:lower() then
            showNotification("Already in favorites: " .. animalName, COLORS.Warning)
            return false
        end
    end
    table.insert(FAVORITES, animalName)
    saveFavorites()
    showNotification("‚≠ê Added to favorites: " .. animalName, COLORS.Green)
    return true
end

local function removeFavorite(animalName)
    for i, name in ipairs(FAVORITES) do
        if name:lower() == animalName:lower() then
            table.remove(FAVORITES, i)
            saveFavorites()
            showNotification("‚ùå Removed from favorites: " .. animalName, COLORS.Error)
            return true
        end
    end
    return false
end

-- ============================================================
-- DESYNC SYSTEM (Full Integration)
-- ============================================================

local function runDesyncEngine()
    for key, value in pairs(DESYNC_FLAGS) do
        pcall(function()
            setfflag(tostring(key), tostring(value))
        end)
    end
end

local function enableDesync()
    task.spawn(runDesyncEngine)
    showNotification("‚úì Desync V3 Enabled", COLORS.Green)
end

-- ============================================================
-- ESP SYSTEM (Full Integration)
-- ============================================================

local function isMyBaseAnimal(animalData)
    if not animalData or not animalData.plot then return false end
    local plots = workspace:FindFirstChild("Plots")
    if not plots then return false end
    local plot = plots:FindFirstChild(animalData.plot)
    if not plot then return false end
    
    local channel = S.Synchronizer:Get(plot.Name)
    if channel then
        local owner = channel:Get("Owner")
        if owner then
            if typeof(owner) == "Instance" and owner:IsA("Player") then
                return owner.UserId == S.LocalPlayer.UserId
            end
        end
    end
    return false
end

local function clearESPForUID(uid)
    local rec = ESP_INSTANCES[uid]
    if not rec then return end
    if rec.highlight then pcall(function() rec.highlight:Destroy() end) end
    if rec.billboard then pcall(function() rec.billboard:Destroy() end) end
    ESP_INSTANCES[uid] = nil
end

local function clearAllESP()
    for uid in pairs(ESP_INSTANCES) do
        clearESPForUID(uid)
    end
    ESP_BEST_UID = nil
end

local function getPodiumWorldPart(animal)
    if not animal.plot or not animal.slot then return nil end
    local plot = workspace.Plots:FindFirstChild(animal.plot)
    if not plot then return nil end
    local podiums = plot:FindFirstChild("AnimalPodiums")
    if not podiums then return nil end
    local podium = podiums:FindFirstChild(animal.slot)
    if not podium then return nil end
    local base = podium:FindFirstChild("Base")
    if not base then return podium end
    local spawn = base:FindFirstChild("Spawn")
    return spawn or base or podium
end

local function refreshAllESP()
    if not screenGui or not CONFIG.ESP_ENABLED then
        clearAllESP()
        return
    end
    
    local activeUIDs = {}
    local bestAnimal = nil
    
    for _, animalData in ipairs(allAnimalsCache) do
        if not isMyBaseAnimal(animalData) then
            bestAnimal = animalData
            break
        end
    end
    
    ESP_BEST_UID = bestAnimal and bestAnimal.uid or nil
    
    for _, animalData in ipairs(allAnimalsCache) do
        if isMyBaseAnimal(animalData) then continue end
        
        if (animalData.uid == ESP_BEST_UID) or (animalData.genValue >= 50000000) then
            local uid = animalData.uid
            activeUIDs[uid] = true
            
            local rec = ESP_INSTANCES[uid]
            local model = getPodiumWorldPart(animalData)
            
            if not model then
                if rec then clearESPForUID(uid) end
            else
                if not rec or rec.part ~= model then
                    if rec then clearESPForUID(uid) end
                    rec = {part = model}
                    
                    local highlight = Instance.new("Highlight")
                    highlight.Adornee = model
                    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
                    highlight.FillTransparency = 0.7
                    highlight.FillColor = COLORS.Green
                    highlight.OutlineTransparency = 0.3
                    highlight.OutlineColor = COLORS.Cyan
                    highlight.Parent = screenGui
                    rec.highlight = highlight
                    
                    local bb = Instance.new("BillboardGui")
                    bb.Adornee = model
                    bb.AlwaysOnTop = true
                    bb.Size = UDim2.new(0, 200, 0, 70)
                    bb.StudsOffset = Vector3.new(0, 3.5, 0)
                    bb.Parent = screenGui
                    
                    local bgFrame = Instance.new("Frame")
                    bgFrame.Size = UDim2.new(1, 0, 1, 0)
                    bgFrame.BackgroundColor3 = COLORS.Surface
                    bgFrame.BackgroundTransparency = 0.2
                    bgFrame.BorderSizePixel = 0
                    bgFrame.Parent = bb
                    
                    Instance.new("UICorner", bgFrame).CornerRadius = UDim.new(0, 8)
                    
                    local stroke = Instance.new("UIStroke")
                    stroke.Color = COLORS.Green
                    stroke.Thickness = 2
                    stroke.Transparency = 0.3
                    stroke.Parent = bgFrame
                    
                    local nameLabel = Instance.new("TextLabel")
                    nameLabel.Size = UDim2.new(1, -10, 0.5, 0)
                    nameLabel.Position = UDim2.new(0, 5, 0, 5)
                    nameLabel.BackgroundTransparency = 1
                    nameLabel.TextColor3 = COLORS.Green
                    nameLabel.TextScaled = true
                    nameLabel.Font = Enum.Font.GothamBold
                    nameLabel.Parent = bgFrame
                    
                    local genLabel = Instance.new("TextLabel")
                    genLabel.Size = UDim2.new(1, -10, 0.5, -5)
                    genLabel.Position = UDim2.new(0, 5, 0.5, 0)
                    genLabel.BackgroundTransparency = 1
                    genLabel.TextColor3 = COLORS.Cyan
                    genLabel.TextScaled = true
                    genLabel.Font = Enum.Font.GothamBold
                    genLabel.Parent = bgFrame
                    
                    rec.billboard = bb
                    rec.labelName = nameLabel
                    rec.labelGen = genLabel
                    ESP_INSTANCES[uid] = rec
                end
                
                rec.labelName.Text = animalData.name
                rec.labelGen.Text = animalData.genText
            end
        end
    end
    
    for uid in pairs(ESP_INSTANCES) do
        if not activeUIDs[uid] then
            clearESPForUID(uid)
        end
    end
end

-- ============================================================
-- AUTO-STEAL SYSTEM (Full Integration)
-- ============================================================

local function findProximityPromptForAnimal(animalData)
    if not animalData then return nil end
    
    local cachedPrompt = PromptMemoryCache[animalData.uid]
    if cachedPrompt and cachedPrompt.Parent then
        return cachedPrompt
    end
    
    local plot = workspace.Plots:FindFirstChild(animalData.plot)
    if not plot then return nil end
    local podiums = plot:FindFirstChild("AnimalPodiums")
    if not podiums then return nil end
    local podium = podiums:FindFirstChild(animalData.slot)
    if not podium then return nil end
    local base = podium:FindFirstChild("Base")
    if not base then return nil end
    local spawn = base:FindFirstChild("Spawn")
    if not spawn then return nil end
    local attach = spawn:FindFirstChild("PromptAttachment")
    if not attach then return nil end
    
    for _, p in ipairs(attach:GetChildren()) do
        if p:IsA("ProximityPrompt") then
            PromptMemoryCache[animalData.uid] = p
            return p
        end
    end
    return nil
end

local function getHRP()
    local c = S.LocalPlayer.Character
    if not c then return end
    return c:FindFirstChild("HumanoidRootPart") or c:FindFirstChild("UpperTorso")
end

local function getAnimalPosition(animalData)
    local plot = workspace.Plots:FindFirstChild(animalData.plot)
    if not plot then return nil end
    local podiums = plot:FindFirstChild("AnimalPodiums")
    if not podiums then return nil end
    local podium = podiums:FindFirstChild(animalData.slot)
    if not podium then return nil end
    return podium:GetPivot().Position
end

local function getNearestAnimal()
    local hrp = getHRP()
    if not hrp then return nil end
    
    local nearest = nil
    local minDist = math.huge
    
    for _, animalData in ipairs(allAnimalsCache) do
        if isMyBaseAnimal(animalData) then continue end
        local pos = getAnimalPosition(animalData)
        if pos then
            local dist = (hrp.Position - pos).Magnitude
            if dist < minDist then
                minDist = dist
                nearest = animalData
            end
        end
    end
    return nearest
end

local function buildStealCallbacks(prompt)
    if InternalStealCache[prompt] then return end
    
    local data = {holdCallbacks = {}, triggerCallbacks = {}, ready = true}
    
    local ok1, conns1 = pcall(getconnections, prompt.PromptButtonHoldBegan)
    if ok1 and type(conns1) == "table" then
        for _, conn in ipairs(conns1) do
            if type(conn.Function) == "function" then
                table.insert(data.holdCallbacks, conn.Function)
            end
        end
    end
    
    local ok2, conns2 = pcall(getconnections, prompt.Triggered)
    if ok2 and type(conns2) == "table" then
        for _, conn in ipairs(conns2) do
            if type(conn.Function) == "function" then
                table.insert(data.triggerCallbacks, conn.Function)
            end
        end
    end
    
    if (#data.holdCallbacks > 0) or (#data.triggerCallbacks > 0) then
        InternalStealCache[prompt] = data
    end
end

local function executeInternalStealAsync(prompt)
    local data = InternalStealCache[prompt]
    if not data or not data.ready then return false end
    data.ready = false
    
    task.spawn(function()
        if #data.holdCallbacks > 0 then
            for _, fn in ipairs(data.holdCallbacks) do
                task.spawn(fn)
            end
        end
        task.wait(1.3)
        if #data.triggerCallbacks > 0 then
            for _, fn in ipairs(data.triggerCallbacks) do
                task.spawn(fn)
            end
        end
        task.wait()
        data.ready = true
    end)
    return true
end

local function attemptSteal(prompt)
    if not prompt or not prompt.Parent then return false end
    buildStealCallbacks(prompt)
    if not InternalStealCache[prompt] then return false end
    return executeInternalStealAsync(prompt)
end

local function getPriorityAnimal()
    for _, priorityName in ipairs(PRIORITY_ANIMALS) do
        for _, animalData in ipairs(allAnimalsCache) do
            if not isMyBaseAnimal(animalData) and animalData.name == priorityName then
                return animalData
            end
        end
    end
    return nil
end

local stealConnection = nil

local function autoStealLoop()
    if stealConnection then stealConnection:Disconnect() end
    
    stealConnection = S.RunService.Heartbeat:Connect(function()
        if not CONFIG.AUTO_STEAL_ENABLED and not CONFIG.AUTO_STEAL_NEAREST_ENABLED and not CONFIG.AUTO_STEAL_PRIORITY_ENABLED then
            return
        end
        
        local targetAnimal = nil
        
        if CONFIG.AUTO_STEAL_PRIORITY_ENABLED then
            targetAnimal = getPriorityAnimal()
            if not targetAnimal then
                if CONFIG.AUTO_STEAL_NEAREST_ENABLED then
                    targetAnimal = getNearestAnimal()
                elseif CONFIG.AUTO_STEAL_ENABLED then
                    for _, animal in ipairs(allAnimalsCache) do
                        if not isMyBaseAnimal(animal) then
                            targetAnimal = animal
                            break
                        end
                    end
                end
            end
        elseif CONFIG.AUTO_STEAL_NEAREST_ENABLED then
            targetAnimal = getNearestAnimal()
        elseif CONFIG.AUTO_STEAL_ENABLED then
            for _, animal in ipairs(allAnimalsCache) do
                if not isMyBaseAnimal(animal) then
                    targetAnimal = animal
                    break
                end
            end
        end
        
        if not targetAnimal or isMyBaseAnimal(targetAnimal) then return end
        
        local prompt = PromptMemoryCache[targetAnimal.uid]
        if not prompt or not prompt.Parent then
            prompt = findProximityPromptForAnimal(targetAnimal)
        end
        
        if prompt then
            attemptSteal(prompt)
        end
    end)
end

-- ============================================================
-- TELEPORT SYSTEM (Full Integration)
-- ============================================================

local function teleportToAnimal(animalData)
    local character = S.LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then
        showNotification("‚ö†Ô∏è Character not found!", COLORS.Warning)
        return false
    end
    
    local hrp = character.HumanoidRootPart
    local plot = workspace.Plots:FindFirstChild(animalData.plot)
    if not plot then
        showNotification("‚ö†Ô∏è Plot not found!", COLORS.Warning)
        return false
    end
    
    local targetPos = Vector3.new(0, 10, 0)
    local podiums = plot:FindFirstChild("AnimalPodiums")
    local animalFolder = podiums and podiums:FindFirstChild(animalData.slot)
    
    if animalFolder then
        local allParts = {}
        local function scan(obj)
            for _, child in ipairs(obj:GetChildren()) do
                if child:IsA("BasePart") then
                    table.insert(allParts, child)
                else
                    scan(child)
                end
            end
        end
        scan(animalFolder)
        
        if #allParts > 0 then
            local closest, minDist = nil, math.huge
            for _, part in ipairs(allParts) do
                local dist = (part.Position - hrp.Position).Magnitude
                if dist < minDist then
                    minDist = dist
                    closest = part
                end
            end
            if closest then
                targetPos = closest.Position
            end
        end
    end
    
    hrp.CFrame = CFrame.new(targetPos)
    showNotification("üöÄ Teleported to " .. animalData.name, COLORS.Green)
    return true
end

local function teleportToHighest()
    if #allAnimalsCache == 0 then
        showNotification("No animals found yet!", COLORS.Warning)
        return
    end
    
    if CONFIG.FAVORITES_PRIORITY_ENABLED and #FAVORITES > 0 then
        for _, favName in ipairs(FAVORITES) do
            for _, animal in ipairs(allAnimalsCache) do
                if animal.name:lower() == favName:lower() then
                    showNotification("üîñ Teleporting to priority: " .. animal.name, COLORS.Green)
                    teleportToAnimal(animal)
                    return
                end
            end
        end
    end
    
    teleportToAnimal(allAnimalsCache[1])
end

-- ============================================================
-- SCANNER SYSTEM (Full Integration)
-- ============================================================

local function updateStats(statLabels)
    if not statLabels then return end
    statLabels.total.Text = tostring(stats.totalAnimals)
    statLabels.value.Text = "$" .. S.NumberUtils:ToString(stats.totalValue) .. "/s"
    statLabels.highest.Text = "$" .. S.NumberUtils:ToString(stats.highestGen) .. "/s"
    statLabels.mutations.Text = tostring(stats.mutationCount)
    statLabels.traits.Text = tostring(stats.traitCount)
end

local function scanSinglePlot(plot, statLabels)
    pcall(function()
        local channel = S.Synchronizer:Get(plot.Name)
        if not channel then return end
        
        local animalList = channel:Get("AnimalList")
        local owner = channel:Get("Owner")
        
        if not owner or not S.Players:FindFirstChild(owner.Name) then
            for i = #allAnimalsCache, 1, -1 do
                if allAnimalsCache[i].plot == plot.Name then
                    table.remove(allAnimalsCache, i)
                end
            end
            if updateAnimalsList then updateAnimalsList() end
            updateStats(statLabels)
            return
        end
        
        local ownerName = owner.Name
        if not animalList then return end
        
        for i = #allAnimalsCache, 1, -1 do
            if allAnimalsCache[i].plot == plot.Name then
                table.remove(allAnimalsCache, i)
            end
        end
        
        for slot, animalData in pairs(animalList) do
            if type(animalData) == "table" then
                local animalName = animalData.Index
                local animalInfo = S.AnimalsData[animalName]
                if animalInfo then
                    local rarity = animalInfo.Rarity
                    local rarityColor = (S.RaritiesData[rarity] and S.RaritiesData[rarity].Color) or COLORS.Green
                    
                    local mutation = animalData.Mutation or "None"
                    local traits = (animalData.Traits and #animalData.Traits > 0) and table.concat(animalData.Traits, ", ") or "None"
                    
                    local genValue = S.AnimalsShared:GetGeneration(animalName, animalData.Mutation, animalData.Traits, nil)
                    local genText = "$" .. S.NumberUtils:ToString(genValue) .. "/s"
                    
                    table.insert(allAnimalsCache, {
                        name = animalInfo.DisplayName or animalName,
                        genText = genText,
                        genValue = genValue,
                        rarity = rarity,
                        rarityColor = rarityColor,
                        mutation = mutation,
                        traits = traits,
                        owner = ownerName,
                        plot = plot.Name,
                        slot = tostring(slot),
                        uid = plot.Name .. "_" .. tostring(slot),
                    })
                end
            end
        end
        
        stats = {
            totalAnimals = 0,
            totalValue = 0,
            highestGen = 0,
            mutationCount = 0,
            traitCount = 0,
        }
        
        for _, animal in ipairs(allAnimalsCache) do
            stats.totalAnimals = stats.totalAnimals + 1
            stats.totalValue = stats.totalValue + animal.genValue
            stats.highestGen = math.max(stats.highestGen, animal.genValue)
            if animal.mutation ~= "None" then
                stats.mutationCount = stats.mutationCount + 1
            end
            if animal.traits ~= "None" then
                stats.traitCount = stats.traitCount + 1
            end
        end
        
        table.sort(allAnimalsCache, function(a, b)
            return a.genValue > b.genValue
        end)
        
        if updateAnimalsList then updateAnimalsList() end
        updateStats(statLabels)
        refreshAllESP()
    end)
end

local function initializePlotScanner(statLabels)
    local plots = workspace:WaitForChild("Plots", 8)
    if not plots then return end
    
    for _, plot in ipairs(plots:GetChildren()) do
        task.spawn(function()
            scanSinglePlot(plot, statLabels)
            plotChannels[plot.Name] = true
        end)
    end
    
    plots.ChildAdded:Connect(function(plot)
        task.wait(0.5)
        scanSinglePlot(plot, statLabels)
        plotChannels[plot.Name] = true
    end)
end

-- ============================================================
-- MODERN GUI CREATION (Nexa Green Theme)
-- ============================================================

local function toggleGui()
    guiVisible = not guiVisible
    if mainFrame then
        mainFrame.Visible = guiVisible
    end
end

local function createModernButton(parent, text, color, callback, order)
    local button = createElement("TextButton", {
        Size = UDim2.new(1, -20, 0, 40),
        Position = UDim2.new(0, 10, 0, 0),
        BackgroundColor3 = color or COLORS.Green,
        BackgroundTransparency = 0.3,
        BorderSizePixel = 0,
        LayoutOrder = order or 0,
        Text = text,
        TextColor3 = COLORS.Text,
        TextSize = 14,
        Font = Enum.Font.GothamBold,
        Parent = parent,
    })
    
    createElement("UICorner", {
        CornerRadius = UDim.new(0, 8),
        Parent = button,
    })
    
    local border = createElement("UIStroke", {
        Color = color or COLORS.Green,
        Thickness = 1,
        Transparency = 0.5,
        ApplyStrokeMode = Enum.ApplyStrokeMode.Border,
        Parent = button,
    })
    
    button.MouseButton1Click:Connect(callback)
    
    button.MouseEnter:Connect(function()
        tween(button, tweenInfoFast, {BackgroundTransparency = 0.1})
        tween(border, tweenInfoFast, {Transparency = 0.2})
    end)
    
    button.MouseLeave:Connect(function()
        tween(button, tweenInfoFast, {BackgroundTransparency = 0.3})
        tween(border, tweenInfoFast, {Transparency = 0.5})
    end)
    
    return button
end

function updateAnimalsList()
    if not contentFrame then return end
    local animalsTab = contentFrame:FindFirstChild("AnimalsTab")
    if not animalsTab then return end
    local scrollFrame = animalsTab:FindFirstChild("AnimalList")
    if not scrollFrame then return end
    
    for _, child in ipairs(scrollFrame:GetChildren()) do
        if child:IsA("Frame") and child.Name == "AnimalEntry" then
            child:Destroy()
        end
    end
    
    for idx, animalData in ipairs(allAnimalsCache) do
        if isMyBaseAnimal(animalData) then continue end
        
        local entry = createElement("Frame", {
            Name = "AnimalEntry",
            Size = UDim2.new(1, 0, 0, 90),
            BackgroundColor3 = COLORS.Surface,
            BackgroundTransparency = 0.3,
            BorderSizePixel = 0,
            LayoutOrder = idx,
            Parent = scrollFrame,
        })
        
        createElement("UICorner", {
            CornerRadius = UDim.new(0, 8),
            Parent = entry,
        })
        
        local border = createElement("UIStroke", {
            Color = COLORS.Green,
            Thickness = 1,
            Transparency = 0.7,
            ApplyStrokeMode = Enum.ApplyStrokeMode.Border,
            Parent = entry,
        })
        
        local nameLabel = createElement("TextLabel", {
            Size = UDim2.new(1, -100, 0, 20),
            Position = UDim2.new(0, 10, 0, 10),
            BackgroundTransparency = 1,
            Text = animalData.name,
            TextColor3 = COLORS.Green,
            TextSize = 15,
            Font = Enum.Font.GothamBold,
            TextXAlignment = Enum.TextXAlignment.Left,
            Parent = entry,
        })
        
        local genLabel = createElement("TextLabel", {
            Size = UDim2.new(1, -100, 0, 16),
            Position = UDim2.new(0, 10, 0, 35),
            BackgroundTransparency = 1,
            Text = animalData.genText,
            TextColor3 = COLORS.Cyan,
            TextSize = 13,
            Font = Enum.Font.GothamSemibold,
            TextXAlignment = Enum.TextXAlignment.Left,
            Parent = entry,
        })
        
        local tpButton = createElement("TextButton", {
            Size = UDim2.new(0, 80, 0, 32),
            Position = UDim2.new(1, -85, 0.5, -16),
            BackgroundColor3 = COLORS.Green,
            BackgroundTransparency = 0.3,
            Text = "TP",
            TextColor3 = COLORS.Text,
            TextSize = 14,
            Font = Enum.Font.GothamBold,
            BorderSizePixel = 0,
            Parent = entry,
        })
        
        createElement("UICorner", {
            CornerRadius = UDim.new(0, 6),
            Parent = tpButton,
        })
        
        tpButton.MouseButton1Click:Connect(function()
            teleportToAnimal(animalData)
        end)
    end
    
    local listLayout = scrollFrame:FindFirstChild("UIListLayout")
    if listLayout then
        scrollFrame.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y + 15)
    end
end

local function createGui()
    screenGui = createElement("ScreenGui", {
        Name = "NexaHub",
        ResetOnSpawn = false,
        DisplayOrder = 999999,
        ZIndexBehavior = Enum.ZIndexBehavior.Global,
        Parent = S.PlayerGui,
    })
    
    mainFrame = createElement("Frame", {
        Name = "MainFrame",
        Size = UDim2.new(0, 420, 0, 550),
        Position = UDim2.new(0.5, -210, 0.5, -275),
        BackgroundColor3 = COLORS.Background,
        BackgroundTransparency = 0.15,
        BorderSizePixel = 0,
        Parent = screenGui,
    })
    
    createElement("UICorner", {
        CornerRadius = UDim.new(0, 12),
        Parent = mainFrame,
    })
    
    local mainBorder = createElement("UIStroke", {
        Color = COLORS.Green,
        Thickness = 2,
        Transparency = 0.5,
        ApplyStrokeMode = Enum.ApplyStrokeMode.Border,
        Parent = mainFrame,
    })
    
    addGreenGlow(mainFrame)
    
    local titleBar = createElement("Frame", {
        Size = UDim2.new(1, 0, 0, 55),
        BackgroundTransparency = 1,
        Parent = mainFrame,
    })
    
    local title = createElement("TextLabel", {
        Size = UDim2.new(1, -60, 0, 25),
        Position = UDim2.new(0, 15, 0, 10),
        BackgroundTransparency = 1,
        Text = "NEXA HUB",
        TextColor3 = COLORS.Green,
        TextSize = 20,
        Font = Enum.Font.GothamBlack,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = titleBar,
    })
    
    local subtitle = createElement("TextLabel", {
        Size = UDim2.new(1, -60, 0, 16),
        Position = UDim2.new(0, 15, 0, 35),
        BackgroundTransparency = 1,
        Text = "Modern Green Edition ‚Ä¢ v1.0",
        TextColor3 = COLORS.TextDim,
        TextSize = 12,
        Font = Enum.Font.Gotham,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = titleBar,
    })
    
    contentFrame = createElement("Frame", {
        Name = "ContentFrame",
        Size = UDim2.new(1, 0, 1, -65),
        BackgroundTransparency = 1,
        Parent = mainFrame,
    })
    
    local scrollFrame = createElement("ScrollingFrame", {
        Name = "ContentScroll",
        Size = UDim2.new(1, -20, 1, -20),
        Position = UDim2.new(0, 10, 0, 10),
        BackgroundColor3 = COLORS.Surface,
        BackgroundTransparency = 0.5,
        BorderSizePixel = 0,
        ScrollBarThickness = 6,
        ScrollBarImageColor3 = COLORS.Green,
        AutomaticCanvasSize = Enum.AutomaticSize.Y,
        Parent = contentFrame,
    })
    
    createElement("UICorner", {
        CornerRadius = UDim.new(0, 10),
        Parent = scrollFrame,
    })
    
    local listLayout = createElement("UIListLayout", {
        Padding = UDim.new(0, 10),
        SortOrder = Enum.SortOrder.LayoutOrder,
        Parent = scrollFrame,
    })
    
    createElement("UIPadding", {
        PaddingTop = UDim.new(0, 10),
        PaddingBottom = UDim.new(0, 10),
        PaddingLeft = UDim.new(0, 10),
        PaddingRight = UDim.new(0, 10),
        Parent = scrollFrame,
    })
    
    local function createSection(title, order)
        local section = createElement("Frame", {
            Size = UDim2.new(1, -20, 0, 30),
            BackgroundTransparency = 1,
            LayoutOrder = order,
            Parent = scrollFrame,
        })
        
        local label = createElement("TextLabel", {
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            Text = title,
            TextColor3 = COLORS.Green,
            TextSize = 16,
            Font = Enum.Font.GothamBold,
            TextXAlignment = Enum.TextXAlignment.Left,
            Parent = section,
        })
        
        return section
    end
    
    local order = 0
    local function nextOrder()
        order = order + 1
        return order
    end
    
    createSection("üéØ AUTO FEATURES", nextOrder())
    
    createModernToggle(scrollFrame, "Auto-Teleport on Start", "AUTO_TP_ENABLED", nil, nextOrder())
    createModernToggle(scrollFrame, "Auto-Steal Highest", "AUTO_STEAL_ENABLED", function(enabled)
        if enabled then CONFIG.AUTO_STEAL_NEAREST_ENABLED = false end
    end, nextOrder())
    createModernToggle(scrollFrame, "Auto-Steal Nearest", "AUTO_STEAL_NEAREST_ENABLED", function(enabled)
        if enabled then CONFIG.AUTO_STEAL_ENABLED = false end
    end, nextOrder())
    createModernToggle(scrollFrame, "Auto-Steal Priority", "AUTO_STEAL_PRIORITY_ENABLED", nil, nextOrder())
    createModernToggle(scrollFrame, "Speed Boost (Steal)", "STEAL_SPEED_ENABLED", nil, nextOrder())
    createModernToggle(scrollFrame, "Disable Animations", "STEAL_DISABLE_ANIM_ENABLED", nil, nextOrder())
    
    createSection("‚ö° QUICK ACTIONS", nextOrder())
    
    createModernButton(scrollFrame, "Teleport to Highest", COLORS.Green, function()
        teleportToHighest()
    end, nextOrder())
    
    createModernButton(scrollFrame, "Desync V3", COLORS.Cyan, function()
        enableDesync()
    end, nextOrder())
    
    createModernButton(scrollFrame, "Rejoin Server", COLORS.Teal, function()
        S.TeleportService:Teleport(game.PlaceId, S.LocalPlayer)
    end, nextOrder())
    
    createSection("üëÅÔ∏è ESP FEATURES", nextOrder())
    
    createModernToggle(scrollFrame, "Animal ESP", "ESP_ENABLED", function(enabled)
        refreshAllESP()
    end, nextOrder())
    createModernToggle(scrollFrame, "Player ESP", "ESP_PLAYERS_ENABLED", nil, nextOrder())
    
    createSection("üõ†Ô∏è UTILITIES", nextOrder())
    
    createModernToggle(scrollFrame, "Floor Steal", "FLOOR_STEAL_ENABLED", nil, nextOrder())
    createModernToggle(scrollFrame, "Invisible Walls", "INVISIBLE_BASE_WALLS_ENABLED", nil, nextOrder())
    createModernToggle(scrollFrame, "Anti-Lag", "ANTI_LAG_ENABLED", nil, nextOrder())
    createModernToggle(scrollFrame, "Optimizer", "OptimizerEnabled", nil, nextOrder())
    
    local animalsTab = createElement("Frame", {
        Name = "AnimalsTab",
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Parent = contentFrame,
    })
    
    local animalScroll = createElement("ScrollingFrame", {
        Name = "AnimalList",
        Size = UDim2.new(1, -20, 1, -20),
        Position = UDim2.new(0, 10, 0, 10),
        BackgroundColor3 = COLORS.Surface,
        BackgroundTransparency = 0.5,
        BorderSizePixel = 0,
        ScrollBarThickness = 6,
        ScrollBarImageColor3 = COLORS.Green,
        AutomaticCanvasSize = Enum.AutomaticSize.Y,
        Parent = animalsTab,
    })
    
    createElement("UICorner", {
        CornerRadius = UDim.new(0, 10),
        Parent = animalScroll,
    })
    
    createElement("UIListLayout", {
        Padding = UDim.new(0, 8),
        SortOrder = Enum.SortOrder.LayoutOrder,
        Parent = animalScroll,
    })
    
    createElement("UIPadding", {
        PaddingTop = UDim.new(0, 10),
        PaddingBottom = UDim.new(0, 10),
        PaddingLeft = UDim.new(0, 10),
        PaddingRight = UDim.new(0, 10),
        Parent = animalScroll,
    })
    
    local statsSection = createElement("Frame", {
        Size = UDim2.new(1, -20, 0, 200),
        Position = UDim2.new(0, 10, 0, 0),
        BackgroundTransparency = 1,
        LayoutOrder = 999,
        Parent = scrollFrame,
    })
    
    local statLabels = {}
    
    local function createStatCard(text, yPos)
        local card = createElement("Frame", {
            Size = UDim2.new(1, 0, 0, 35),
            Position = UDim2.new(0, 0, 0, yPos),
            BackgroundColor3 = COLORS.Surface,
            BackgroundTransparency = 0.3,
            BorderSizePixel = 0,
            Parent = statsSection,
        })
        
        createElement("UICorner", {
            CornerRadius = UDim.new(0, 8),
            Parent = card,
        })
        
        local label = createElement("TextLabel", {
            Size = UDim2.new(0.5, 0, 1, 0),
            Position = UDim2.new(0, 10, 0, 0),
            BackgroundTransparency = 1,
            Text = text,
            TextColor3 = COLORS.TextDim,
            TextSize = 12,
            Font = Enum.Font.Gotham,
            TextXAlignment = Enum.TextXAlignment.Left,
            Parent = card,
        })
        
        local value = createElement("TextLabel", {
            Size = UDim2.new(0.5, -10, 1, 0),
            Position = UDim2.new(0.5, 0, 0, 0),
            BackgroundTransparency = 1,
            Text = "0",
            TextColor3 = COLORS.Green,
            TextSize = 14,
            Font = Enum.Font.GothamBold,
            TextXAlignment = Enum.TextXAlignment.Right,
            Parent = card,
        })
        
        return value
    end
    
    statLabels.total = createStatCard("Total Animals", 0)
    statLabels.value = createStatCard("Total Value/s", 45)
    statLabels.highest = createStatCard("Highest Gen", 90)
    statLabels.mutations = createStatCard("Mutations", 135)
    statLabels.traits = createStatCard("Traits", 180)
    
    local dragging, dragStart, startPos
    
    titleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = mainFrame.Position
        end
    end)
    
    titleBar.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
            saveGuiPosition()
        end
    end)
    
    S.UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            mainFrame.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)
    
    return statLabels
end

-- ============================================================
-- KEYBIND HANDLERS (Full Integration)
-- ============================================================

S.UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.KeyCode == CONFIG.TELEPORT_KEYBIND then
        teleportToHighest()
    elseif input.KeyCode == CONFIG.TOGGLE_GUI_KEYBIND then
        toggleGui()
    elseif input.KeyCode == CONFIG.DESYNC_KEYBIND then
        enableDesync()
    elseif input.KeyCode == CONFIG.FLOOR_STEAL_KEYBIND then
        CONFIG.FLOOR_STEAL_ENABLED = not CONFIG.FLOOR_STEAL_ENABLED
        saveConfig()
        showNotification(CONFIG.FLOOR_STEAL_ENABLED and "‚úì Floor Steal ON" or "‚úó Floor Steal OFF", COLORS.Green)
    elseif input.KeyCode == CONFIG.REJOIN_KEYBIND then
        S.TeleportService:Teleport(game.PlaceId, S.LocalPlayer)
    end
end)

-- ============================================================
-- INITIALIZATION
-- ============================================================

pcall(loadConfig)
pcall(loadFavorites)

if not game:IsLoaded() then
    game.Loaded:Wait()
end

task.spawn(function()
    local labels = createGui()
    statLabels = labels
    initializePlotScanner(labels)
    autoStealLoop()
    
    if CONFIG.AUTO_TP_ENABLED then
        task.wait(1)
        teleportToHighest()
    end
    
    if CONFIG.AUTO_DESYNC_ENABLED then
        task.wait(0.5)
        enableDesync()
    end
    
    if CONFIG.AUTO_HIDE_ENABLED then
        task.wait(1)
        toggleGui()
    end
    
    showNotification("‚úì Nexa Hub Loaded Successfully", COLORS.Green)
end)

screenGui.Destroying:Connect(function()
    for _, conn in ipairs(scannerConnections) do
        if typeof(conn) == "RBXScriptConnection" then
            conn:Disconnect()
        end
    end
    clearAllESP()
end)

print("‚úì Nexa Hub - Modern Green Edition Loaded!")
print("‚úì All Features Integrated Successfully")
        Position = UDim2.new(0, 0, 0, 

-- ============================================================
-- SECTION
