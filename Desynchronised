--[[
    Nexa Cheats v5.1 - GREEN MODERN BOX UI
    Full integration with mobile toggle support and PC keybinds
    All original functions preserved
]]

-- ============================================================
-- SECTION 6: UI CREATION FUNCTIONS
-- ============================================================

local function createSectionHeader(parent, text)
    local header = createElement("TextLabel", {
        Size = UDim2.new(1, -20, 0, 30),
        BackgroundTransparency = 1,
        Text = text,
        TextColor3 = COLORS.Primary,
        TextSize = 15,
        Font = Enum.Font.GothamBold,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = parent,
    })
    
    return header
end

local function createToggle(parent, text, configKey, callback, showKeybind)
    local container = createElement("Frame", {
        Size = UDim2.new(1, -20, 0, 40),
        BackgroundColor3 = COLORS.Surface,
        BackgroundTransparency = 0.5,
        BorderSizePixel = 0,
        Parent = parent,
    })
    
    createElement("UICorner", {
        CornerRadius = UDim.new(0, 8),
        Parent = container,
    })
    
    local labelWidth = showKeybind and 0.5 or 0.7
    
    local label = createElement("TextLabel", {
        Size = UDim2.new(labelWidth, 0, 1, 0),
        Position = UDim2.new(0, 12, 0, 0),
        BackgroundTransparency = 1,
        Text = text,
        TextColor3 = COLORS.Text,
        TextSize = 13,
        Font = Enum.Font.GothamMedium,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = container,
    })
    
    -- Keybind indicator for PC
    if showKeybind and not isMobile then
        local keybindLabel = createElement("TextLabel", {
            Size = UDim2.new(0.25, 0, 1, 0),
            Position = UDim2.new(labelWidth, 0, 0, 0),
            BackgroundTransparency = 1,
            Text = CONFIG[showKeybind] and "[" .. CONFIG[showKeybind].Name .. "]" or "[Not Set]",
            TextColor3 = COLORS.Accent,
            TextSize = 11,
            Font = Enum.Font.GothamBold,
            TextXAlignment = Enum.TextXAlignment.Left,
            Parent = container,
        })
    end
    
    local isEnabled = CONFIG[configKey] or false
    
    local toggleBg = createElement("Frame", {
        Size = UDim2.new(0, 50, 0, 24),
        Position = UDim2.new(1, -60, 0.5, -12),
        BackgroundColor3 = isEnabled and COLORS.Primary or COLORS.Surface,
        BackgroundTransparency = 0.3,
        BorderSizePixel = 0,
        Parent = container,
    })
    
    createElement("UICorner", {
        CornerRadius = UDim.new(1, 0),
        Parent = toggleBg,
    })
    
    local circle = createElement("Frame", {
        Size = UDim2.new(0, 18, 0, 18),
        Position = isEnabled and UDim2.new(0, 29, 0.5, -9) or UDim2.new(0, 3, 0.5, -9),
        BackgroundColor3 = COLORS.Text,
        BorderSizePixel = 0,
        Parent = toggleBg,
    })
    
    createElement("UICorner", {
        CornerRadius = UDim.new(1, 0),
        Parent = circle,
    })
    
    local button = createElement("TextButton", {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Text = "",
        Parent = container,
    })
    
    button.MouseButton1Click:Connect(function()
        CONFIG[configKey] = not CONFIG[configKey]
        isEnabled = CONFIG[configKey]
        
        tween(toggleBg, tweenInfoFast, {
            BackgroundColor3 = isEnabled and COLORS.Primary or COLORS.Surface,
        })
        
        tween(circle, tweenInfoFast, {
            Position = isEnabled and UDim2.new(0, 29, 0.5, -9) or UDim2.new(0, 3, 0.5, -9),
        })
        
        if callback then callback(isEnabled) end
        saveConfig()
    end)
    
    return container
end

local function createActionButton(parent, text, callback)
    local button = createElement("TextButton", {
        Size = UDim2.new(1, -20, 0, 40),
        BackgroundColor3 = COLORS.Primary,
        BackgroundTransparency = 0.3,
        BorderSizePixel = 0,
        Text = text,
        TextColor3 = COLORS.Text,
        TextSize = 14,
        Font = Enum.Font.GothamBold,
        Parent = parent,
    })
    
    createElement("UICorner", {
        CornerRadius = UDim.new(0, 8),
        Parent = button,
    })
    
    button.MouseEnter:Connect(function()
        tween(button, tweenInfoFast, {
            BackgroundTransparency = 0.1,
        })
    end)
    
    button.MouseLeave:Connect(function()
        tween(button, tweenInfoFast, {
            BackgroundTransparency = 0.3,
        })
    end)
    
    button.MouseButton1Click:Connect(callback)
    
    return button
end

local function createKeybindButton(parent, text, configKey)
    if isMobile then return nil end
    
    local container = createElement("Frame", {
        Size = UDim2.new(1, -20, 0, 50),
        BackgroundColor3 = COLORS.Surface,
        BackgroundTransparency = 0.5,
        BorderSizePixel = 0,
        Parent = parent,
    })
    
    createElement("UICorner", {
        CornerRadius = UDim.new(0, 8),
        Parent = container,
    })
    
    local label = createElement("TextLabel", {
        Size = UDim2.new(0.6, 0, 1, 0),
        Position = UDim2.new(0, 12, 0, 0),
        BackgroundTransparency = 1,
        Text = text,
        TextColor3 = COLORS.Text,
        TextSize = 13,
        Font = Enum.Font.GothamMedium,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = container,
    })
    
    local keyButton = createElement("TextButton", {
        Size = UDim2.new(0, 90, 0, 34),
        Position = UDim2.new(1, -100, 0.5, -17),
        BackgroundColor3 = COLORS.Primary,
        BackgroundTransparency = 0.4,
        Text = CONFIG[configKey] and CONFIG[configKey].Name or "Not Set",
        TextColor3 = COLORS.Text,
        TextSize = 13,
        Font = Enum.Font.GothamBold,
        BorderSizePixel = 0,
        Parent = container,
    })
    
    createElement("UICorner", {
        CornerRadius = UDim.new(0, 8),
        Parent = keyButton,
    })
    
    local isListening = false
    keyButton.MouseButton1Click:Connect(function()
        if isListening then return end
        isListening = true
        keyButton.Text = "..."
        keyButton.BackgroundColor3 = COLORS.Warning
        
        local conn
        conn = S.UserInputService.InputBegan:Connect(function(input, gp)
            if input.UserInputType == Enum.UserInputType.Keyboard then
                local newKey = input.KeyCode
                keyButton.Text = newKey.Name
                keyButton.BackgroundColor3 = COLORS.Primary
                CONFIG[configKey] = newKey
                saveConfig()
                isListening = false
                conn:Disconnect()
            end
        end)
    end)
    
    return container
end

local function createCategoryButton(parent, text, icon, category, index)
    local button = createElement("TextButton", {
        Name = "CategoryBtn_" .. category,
        Size = UDim2.new(1, -20, 0, 45),
        Position = UDim2.new(0, 10, 0, 10 + (index * 55)),
        BackgroundColor3 = currentCategory == category and COLORS.Primary or COLORS.Surface,
        BackgroundTransparency = currentCategory == category and 0.3 or 0.5,
        BorderSizePixel = 0,
        Text = "",
        Parent = parent,
    })
    
    createElement("UICorner", {
        CornerRadius = UDim.new(0, 8),
        Parent = button,
    })
    
    createElement("UIStroke", {
        Color = COLORS.Primary,
        Thickness = currentCategory == category and 2 or 1,
        Transparency = currentCategory == category and 0.3 or 0.7,
        Parent = button,
    })
    
    local iconLabel = createElement("TextLabel", {
        Size = UDim2.new(0, 30, 0, 30),
        Position = UDim2.new(0, 10, 0.5, -15),
        BackgroundTransparency = 1,
        Text = icon,
        TextColor3 = currentCategory == category and COLORS.Primary or COLORS.TextDim,
        TextSize = 20,
        Font = Enum.Font.GothamBold,
        Parent = button,
    })
    
    local textLabel = createElement("TextLabel", {
        Size = UDim2.new(1, -50, 1, 0),
        Position = UDim2.new(0, 45, 0, 0),
        BackgroundTransparency = 1,
        Text = text,
        TextColor3 = currentCategory == category and COLORS.Primary or COLORS.Text,
        TextSize = 14,
        Font = Enum.Font.GothamBold,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = button,
    })
    
    button.MouseEnter:Connect(function()
        if currentCategory ~= category then
            tween(button, tweenInfoFast, {
                BackgroundColor3 = COLORS.Secondary,
                BackgroundTransparency = 0.4,
            })
        end
    end)
    
    button.MouseLeave:Connect(function()
        if currentCategory ~= category then
            tween(button, tweenInfoFast, {
                BackgroundColor3 = COLORS.Surface,
                BackgroundTransparency = 0.5,
            })
        end
    end)
    
    return button, iconLabel, textLabel
end

local function switchCategory(category, categoryButtons)
    currentCategory = category
    
    for name, components in pairs(categoryButtons) do
        local isActive = (name == category)
        tween(components.button, tweenInfoFast, {
            BackgroundColor3 = isActive and COLORS.PRIMARY or COLORS.Surface,
            BackgroundTransparency = isActive and 0.3 or 0.5,
        })
        tween(components.icon, tweenInfoFast, {
            TextColor3 = isActive and COLORS.Primary or COLORS.TextDim,
        })
        tween(components.label, tweenInfoFast, {
            TextColor3 = isActive and COLORS.Primary or COLORS.Text,
        })
        
        local stroke = components.button:FindFirstChildOfClass("UIStroke")
        if stroke then
            tween(stroke, tweenInfoFast, {
                Thickness = isActive and 2 or 1,
                Transparency = isActive and 0.3 or 0.7,
            })
        end
    end
    
    for _, child in ipairs(contentFrame:GetChildren()) do
        if not child:IsA("UIListLayout") and not child:IsA("UIPadding") then
            child:Destroy()
        end
    end
    
    if category == "steal" then
        createToggle(contentFrame, "Auto-Steal Highest Gen", "AUTO_STEAL_ENABLED", function(enabled)
            if enabled then CONFIG.AUTO_STEAL_NEAREST_ENABLED = false end
        end, "TELEPORT_KEYBIND").LayoutOrder = 1
        
        createToggle(contentFrame, "Auto-Steal Nearest", "AUTO_STEAL_NEAREST_ENABLED", function(enabled)
            if enabled then CONFIG.AUTO_STEAL_ENABLED = false end
        end).LayoutOrder = 2
        
        createToggle(contentFrame, "Auto-Steal Priority Animals", "AUTO_STEAL_PRIORITY_ENABLED").LayoutOrder = 3
        createToggle(contentFrame, "Speed Boost During Steal", "STEAL_SPEED_ENABLED").LayoutOrder = 4
        createToggle(contentFrame, "Disable Animations", "STEAL_DISABLE_ANIM_ENABLED").LayoutOrder = 5
        createToggle(contentFrame, "Predictive Stealing", "PREDICTIVE_STEAL").LayoutOrder = 6
        
    elseif category == "teleport" then
        createActionButton(contentFrame, "ðŸš€ Teleport to Highest", function()
            teleportToHighest()
        end).LayoutOrder = 1
        
        createToggle(contentFrame, "Auto-TP on Start", "AUTO_TP_ENABLED", nil, "TELEPORT_KEYBIND").LayoutOrder = 2
        createToggle(contentFrame, "Safe Teleport (Carpet)", "SAFE_TELEPORT").LayoutOrder = 3
        createToggle(contentFrame, "Favorites Priority", "FAVORITES_PRIORITY_ENABLED").LayoutOrder = 4
        
    elseif category == "misc" then
        createActionButton(contentFrame, "âš¡ Enable Desync V3", function()
            enableDesync()
        end).LayoutOrder = 1
        
        createActionButton(contentFrame, "ðŸ”„ Rejoin Server", function()
            rejoinServer()
        end).LayoutOrder = 2
        
        createActionButton(contentFrame, "ðŸŽ¯ Instant Cloner", function()
            instantCloner()
        end).LayoutOrder = 3
        
        createActionButton(contentFrame, "âŒ Kick Self", function()
            kickSelf()
        end).LayoutOrder = 4
        
        createToggle(contentFrame, "Load Tuff Optimizer", "OptimizerEnabled").LayoutOrder = 5
        createToggle(contentFrame, "Anti-Lag", "ANTI_LAG_ENABLED").LayoutOrder = 6
        createToggle(contentFrame, "Floor Steal", "FLOOR_STEAL_ENABLED", function(enabled)
            if enabled then startFloorSteal() else stopFloorSteal() end
        end, "FLOOR_STEAL_KEYBIND").LayoutOrder = 7
        createToggle(contentFrame, "Xray Base Walls", "INVISIBLE_BASE_WALLS_ENABLED").LayoutOrder = 8
        createToggle(contentFrame, "Auto-Desync on Start", "AUTO_DESYNC_ENABLED").LayoutOrder = 9
        createToggle(contentFrame, "Auto-Hide GUI on Start", "AUTO_HIDE_ENABLED").LayoutOrder = 10
        
    elseif category == "esp" then
        createToggle(contentFrame, "Brainrot ESP", "ESP_ENABLED").LayoutOrder = 1
        createToggle(contentFrame, "Player ESP", "ESP_PLAYERS_ENABLED").LayoutOrder = 2
        
        createSectionHeader(contentFrame, "â•â•â• NEXA USERS â•â•â•").LayoutOrder = 3
        
        -- Show list of Nexa users
        local nexaCount = 0
        for player, _ in pairs(NEXA_USERS) do
            if player and player.Parent then
                nexaCount = nexaCount + 1
                local userLabel = createElement("TextLabel", {
                    Size = UDim2.new(1, -20, 0, 35),
                    BackgroundColor3 = COLORS.Primary,
                    BackgroundTransparency = 0.7,
                    BorderSizePixel = 0,
                    Text = "ðŸ”¥ " .. player.Name,
                    TextColor3 = COLORS.Text,
                    TextSize = 13,
                    Font = Enum.Font.GothamBold,
                    LayoutOrder = 3 + nexaCount,
                    Parent = contentFrame,
                })
                
                createElement("UICorner", {
                    CornerRadius = UDim.new(0, 8),
                    Parent = userLabel,
                })
            end
        end
        
        if nexaCount == 0 then
            local noUsers = createElement("TextLabel", {
                Size = UDim2.new(1, -20, 0, 35),
                BackgroundColor3 = COLORS.Surface,
                BackgroundTransparency = 0.5,
                BorderSizePixel = 0,
                Text = "No other Nexa users detected",
                TextColor3 = COLORS.TextDim,
                TextSize = 12,
                Font = Enum.Font.Gotham,
                LayoutOrder = 4,
                Parent = contentFrame,
            })
            
            createElement("UICorner", {
                CornerRadius = UDim.new(0, 8),
                Parent = noUsers,
            })
        end
        
    elseif category == "keybinds" then
        if not isMobile then
            createKeybindButton(contentFrame, "Toggle GUI", "TOGGLE_GUI_KEYBIND").LayoutOrder = 1
            createKeybindButton(contentFrame, "Teleport to Highest", "TELEPORT_KEYBIND").LayoutOrder = 2
            createKeybindButton(contentFrame, "Desync V3", "DESYNC_KEYBIND").LayoutOrder = 3
            createKeybindButton(contentFrame, "Instant Cloner", "INSTANT_CLONER_KEYBIND").LayoutOrder = 4
            createKeybindButton(contentFrame, "Floor Steal", "FLOOR_STEAL_KEYBIND").LayoutOrder = 5
            createKeybindButton(contentFrame, "Kick Self", "KICK_SELF_KEYBIND").LayoutOrder = 6
            createKeybindButton(contentFrame, "Rejoin Server", "REJOIN_KEYBIND").LayoutOrder = 7
        else
            local mobileLabel = createElement("TextLabel", {
                Size = UDim2.new(1, -20, 0, 60),
                BackgroundTransparency = 1,
                Text = "ðŸ“± Mobile Device Detected\n\nKeybinds are not available on mobile.\nUse toggles in other categories instead.",
                TextColor3 = COLORS.TextDim,
                TextSize = 14,
                Font = Enum.Font.Gotham,
                TextWrapped = true,
                LayoutOrder = 1,
                Parent = contentFrame,
            })
        end
    end
end

local function createMainGui()
    screenGui = createElement("ScreenGui", {
        Name = "NexaCheats",
        ResetOnSpawn = false,
        DisplayOrder = 999999,
        ZIndexBehavior = Enum.ZIndexBehavior.Global,
        Parent = S.PlayerGui,
    })
    
    mainFrame = createElement("Frame", {
        Name = "MainFrame",
        Size = UDim2.new(0, 700, 0, 500),
        Position = UDim2.new(0.5, -350, 0.5, -250),
        BackgroundColor3 = COLORS.Background,
        BackgroundTransparency = 0.1,
        BorderSizePixel = 0,
        Parent = screenGui,
    })
    
    createElement("UICorner", {
        CornerRadius = UDim.new(0, 12),
        Parent = mainFrame,
    })
    
    createElement("UIStroke", {
        Color = COLORS.Primary,
        Thickness = 2,
        Transparency = 0.5,
        Parent = mainFrame,
    })
    
    local titleBar = createElement("Frame", {
        Size = UDim2.new(1, 0, 0, 50),
        BackgroundColor3 = COLORS.Surface,
        BackgroundTransparency = 0.3,
        BorderSizePixel = 0,
        Parent = mainFrame,
    })
    
    createElement("UICorner", {
        CornerRadius = UDim.new(0, 12),
        Parent = titleBar,
    })
    
    local title = createElement("TextLabel", {
        Size = UDim2.new(1, -120, 0, 22),
        Position = UDim2.new(0, 20, 0, 8),
        BackgroundTransparency = 1,
        Text = "ðŸ”¥ NEXA CHEATS",
        TextColor3 = COLORS.Primary,
        TextSize = 18,
        Font = Enum.Font.GothamBold,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = titleBar,
    })
    
    local subtitle = createElement("TextLabel", {
        Size = UDim2.new(1, -120, 0, 14),
        Position = UDim2.new(0, 20, 0, 32),
        BackgroundTransparency = 1,
        Text = "v5.1 | discord.gg/nexacheats",
        TextColor3 = COLORS.TextDim,
        TextSize = 11,
        Font = Enum.Font.Gotham,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = titleBar,
    })
    
    local closeBtn = createElement("TextButton", {
        Size = UDim2.new(0, 40, 0, 40),
        Position = UDim2.new(1, -50, 0.5, -20),
        BackgroundColor3 = COLORS.Error,
        BackgroundTransparency = 0.3,
        Text = "Ã—",
        TextColor3 = COLORS.Text,
        TextSize = 24,
        Font = Enum.Font.GothamBold,
        BorderSizePixel = 0,
        Parent = titleBar,
    })
    
    createElement("UICorner", {
        CornerRadius = UDim.new(0, 8),
        Parent = closeBtn,
    })
    
    closeBtn.MouseButton1Click:Connect(function()
        guiVisible = false
        mainFrame.Visible = false
    end)
    
    local sidebar = createElement("Frame", {
        Size = UDim2.new(0, 180, 1, -60),
        Position = UDim2.new(0, 10, 0, 55),
        BackgroundColor3 = COLORS.CategoryBg,
        BackgroundTransparency = 0.3,
        BorderSizePixel = 0,
        Parent = mainFrame,
    })
    
    createElement("UICorner", {
        CornerRadius = UDim.new(0, 10),
        Parent = sidebar,
    })
    
    contentFrame = createElement("ScrollingFrame", {
        Name = "ContentFrame",
        Size = UDim2.new(1, -210, 1, -70),
        Position = UDim2.new(0, 200, 0, 60),
        BackgroundColor3 = COLORS.CategoryBg,
        BackgroundTransparency = 0.3,
        BorderSizePixel = 0,
        ScrollBarThickness = 6,
        ScrollBarImageColor3 = COLORS.Primary,
        Parent = mainFrame,
    })
    
    createElement("UICorner", {
        CornerRadius = UDim.new(0, 10),
        Parent = contentFrame,
    })
    
    createElement("UIListLayout", {
        Padding = UDim.new(0, 10),
        SortOrder = Enum.SortOrder.LayoutOrder,
        HorizontalAlignment = Enum.HorizontalAlignment.Center,
        Parent = contentFrame,
    })
    
    createElement("UIPadding", {
        PaddingTop = UDim.new(0, 10),
        PaddingBottom = UDim.new(0, 10),
        Parent = contentFrame,
    })
    
    local categories = {
        {name = "steal", text = "Auto Steal", icon = "âš¡"},
        {name = "teleport", text = "Teleport", icon = "ðŸš€"},
        {name = "misc", text = "Misc", icon = "âš™ï¸"},
        {name = "esp", text = "ESP", icon = "ðŸ‘ï¸"},
        {name = "keybinds", text = "Keybinds", icon = "âŒ¨ï¸"},
    }
    
    local categoryButtons = {}
    
    for i, cat in ipairs(categories) do
        local btn, icon, label = createCategoryButton(sidebar, cat.text, cat.icon, cat.name, i - 1)
        categoryButtons[cat.name] = {button = btn, icon = icon, label = label}
        
        btn.MouseButton1Click:Connect(function()
            switchCategory(cat.name, categoryButtons)
        end)
    end
    
    switchCategory("steal", categoryButtons)
    
    local dragging, dragStart, startPos
    titleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = mainFrame.Position
        end
    end)
    
    titleBar.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
        end
    end)
    
    S.UserInputService.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - dragStart
            mainFrame.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)
end

-- ============================================================
-- SECTION 7: KEYBIND HANDLERS
-- ============================================================

S.UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed or isMobile then return end
    
    if input.KeyCode == CONFIG.TELEPORT_KEYBIND then
        teleportToHighest()
    elseif input.KeyCode == CONFIG.TOGGLE_GUI_KEYBIND then
        guiVisible = not guiVisible
        if mainFrame then mainFrame.Visible = guiVisible end
    elseif input.KeyCode == CONFIG.INSTANT_CLONER_KEYBIND then
        instantCloner()
    elseif input.KeyCode == CONFIG.KICK_SELF_KEYBIND then
        kickSelf()
    elseif input.KeyCode == CONFIG.REJOIN_KEYBIND then
        rejoinServer()
    elseif input.KeyCode == CONFIG.FLOOR_STEAL_KEYBIND then
        CONFIG.FLOOR_STEAL_ENABLED = not CONFIG.FLOOR_STEAL_ENABLED
        saveConfig()
        if CONFIG.FLOOR_STEAL_ENABLED then
            startFloorSteal()
            showNotification("Floor Steal Enabled", COLORS.Success)
        else
            stopFloorSteal()
            showNotification("Floor Steal Disabled", COLORS.Error)
        end
    elseif input.KeyCode == CONFIG.DESYNC_KEYBIND then
        enableDesync()
    end
end)

-- ============================================================
-- SECTION 8: INITIALIZATION
-- ============================================================

pcall(loadConfig)
pcall(loadFavorites)

if not game:IsLoaded() then
    game.Loaded:Wait()
end

createMainGui()
autoStealLoop()
setupNexaDetection()

if CONFIG.AUTO_TP_ENABLED then
    task.spawn(function()
        task.wait(2)
        teleportToHighest()
    end)
end

if CONFIG.AUTO_DESYNC_ENABLED then
    task.spawn(function()
        task.wait(1)
        enableDesync()
    end)
end

if CONFIG.AUTO_HIDE_ENABLED then
    task.spawn(function()
        task.wait(1)
        if mainFrame and guiVisible then
            guiVisible = false
            mainFrame.Visible = false
        end
    end)
end

if CONFIG.FLOOR_STEAL_ENABLED then
    startFloorSteal()
end

print("âœ… Nexa Cheats v5.1 Loaded!")
print("ðŸ”¥ Device:", isMobile and "Mobile" or "PC")
print("ðŸ” Scanning for other Nexa users...")
if not isMobile then
    print("âŒ¨ï¸  Press", CONFIG.TOGGLE_GUI_KEYBIND and CONFIG.TOGGLE_GUI_KEYBIND.Name or "not set", "to toggle GUI")
end1: CONFIGURATION
-- ============================================================

getgenv().BRAINROT_CONFIG = getgenv().BRAINROT_CONFIG or {
    TELEPORT_KEYBIND = nil,
    TOGGLE_GUI_KEYBIND = nil,
    INSTANT_CLONER_KEYBIND = nil,
    KICK_SELF_KEYBIND = nil,
    FLOOR_STEAL_KEYBIND = nil,
    REJOIN_KEYBIND = nil,
    DESYNC_KEYBIND = nil,
    AUTO_TP_ENABLED = false,
    AUTO_HIDE_ENABLED = false,
    AUTO_STEAL_ENABLED = false,
    AUTO_STEAL_NEAREST_ENABLED = false,
    AUTO_STEAL_PRIORITY_ENABLED = false,
    PREDICTIVE_STEAL = true,
    OptimizerEnabled = false,
    FLOOR_STEAL_ENABLED = false,
    AUTO_DESYNC_ENABLED = false,
    STEAL_SPEED_ENABLED = false,
    STEAL_DISABLE_ANIM_ENABLED = false,
    GUI_POSITION_X = nil,
    GUI_POSITION_Y = nil,
    SHOW_ALL_RARITIES = true,
    SHOW_MUTATIONS_ONLY = false,
    SHOW_TRAITS_ONLY = false,
    MIN_GEN_VALUE = 0,
    FAVORITES_PRIORITY_ENABLED = false,
    INVISIBLE_BASE_WALLS_ENABLED = false,
    SAFE_TELEPORT = true,
    ESP_ENABLED = false,
    ESP_PLAYERS_ENABLED = false,
    ANTI_LAG_ENABLED = false,
    ANTI_BEE_DISCO_ENABLED = false,
    ANTI_RAGDOLL_V1_ENABLED = false,
    ANTI_RAGDOLL_V2_ENABLED = false,
}

local PRIORITY_ANIMALS = {
    "Strawberry Elephant", "Meowl", "Headless Horseman", "Dragon Cannelloni",
    "Capitano Moby", "Cooki and Milki", "La Supreme Combinasion",
    "Burguro and Fryuro", "Garama and Madundung", "Lavadorito Spinito",
    "Spooky and Pumpky", "La Casa Boo", "La Secret Combinasion",
    "Chillin Chili", "Ketchuru and Musturu", "Ketupat Kepat",
    "La Taco Combinasion", "Tang Tang Keletang", "Tictac Sahur",
    "W or L", "Spaghetti Tualetti", "Nuclearo Dinossauro", "Money Money Puggy"
}

local CONFIG = getgenv().BRAINROT_CONFIG

if not getgenv().BRAINROT_FAVORITES then
    getgenv().BRAINROT_FAVORITES = {}
end

local FAVORITES = getgenv().BRAINROT_FAVORITES

local Config = {
    FAVORITES_FILE = "BrainrotFinderFavorites.json",
    CONFIG_FILE_NAME = "BrainrotFinderConfig.json"
}

-- GREEN THEME COLORS
local COLORS = {
    Background = Color3.fromRGB(15, 20, 15),
    Surface = Color3.fromRGB(25, 35, 25),
    Primary = Color3.fromRGB(50, 255, 130),
    Secondary = Color3.fromRGB(40, 200, 100),
    Accent = Color3.fromRGB(80, 255, 150),
    Text = Color3.fromRGB(255, 255, 255),
    TextDim = Color3.fromRGB(200, 220, 200),
    Success = Color3.fromRGB(50, 255, 130),
    Warning = Color3.fromRGB(255, 200, 50),
    Error = Color3.fromRGB(255, 80, 80),
    CategoryBg = Color3.fromRGB(20, 28, 20),
}

local DESYNC_FLAGS = {
    LargeReplicatorEnabled9 = true,
    GameNetDontSendRedundantNumTimes = 1,
    MaxTimestepMultiplierAcceleration = 2147483647,
    InterpolationFrameVelocityThresholdMillionth = 5,
    CheckPVDifferencesForInterpolationMinRotVelThresholdRadsPerSecHundredth = 1,
    TimestepArbiterVelocityCriteriaThresholdTwoDt = 2147483646,
    GameNetPVHeaderLinearVelocityZeroCutoffExponent = -5000,
    TimestepArbiterHumanoidTurningVelThreshold = 1,
    LargeReplicatorSerializeWrite4 = true,
    SimExplicitlyCappedTimestepMultiplier = 2147483646,
    InterpolationFrameRotVelocityThresholdMillionth = 5,
    ServerMaxBandwith = 52,
    LargeReplicatorSerializeRead3 = true,
    GameNetDontSendRedundantDeltaPositionMillionth = 1,
    PhysicsSenderMaxBandwidthBps = 20000,
    CheckPVCachedVelThresholdPercent = 10,
    NextGenReplicatorEnabledWrite4 = true,
    LargeReplicatorWrite5 = true,
    MaxMissedWorldStepsRemembered = -2147483648,
    StreamJobNOUVolumeCap = 2147483647,
    CheckPVLinearVelocityIntegrateVsDeltaPositionThresholdPercent = 1,
    DisableDPIScale = true,
    WorldStepMax = 30,
    InterpolationFramePositionThresholdMillionth = 5,
    MaxAcceptableUpdateDelay = 1,
    TimestepArbiterOmegaThou = 1073741823,
    CheckPVCachedRotVelThresholdPercent = 10,
    StreamJobNOUVolumeLengthCap = 2147483647,
    S2PhysicsSenderRate = 15000,
    MaxTimestepMultiplierBuoyancy = 2147483647,
    SimOwnedNOUCountThresholdMillionth = 2147483647,
    ReplicationFocusNouExtentsSizeCutoffForPauseStuds = 2147483647,
    LargeReplicatorRead5 = true,
    CheckPVDifferencesForInterpolationMinVelThresholdStudsPerSecHundredth = 1,
    MaxDataPacketPerSend = 2147483647,
    MaxTimestepMultiplierContstraint = 2147483647,
    DebugSendDistInSteps = -2147483648,
    GameNetPVHeaderRotationalVelocityZeroCutoffExponent = -5000,
    AngularVelociryLimit = 360
}

-- ============================================================
-- SECTION 2: SERVICES & MODULES
-- ============================================================

local S = {
    Players = game:GetService("Players"),
    UserInputService = game:GetService("UserInputService"),
    TweenService = game:GetService("TweenService"),
    ReplicatedStorage = game:GetService("ReplicatedStorage"),
    HttpService = game:GetService("HttpService"),
    RunService = game:GetService("RunService"),
    Stats = game:GetService("Stats"),
    TeleportService = game:GetService("TeleportService"),
    Lighting = game:GetService("Lighting"),
}

S.Packages = S.ReplicatedStorage:WaitForChild("Packages")
S.Datas = S.ReplicatedStorage:WaitForChild("Datas")
S.Shared = S.ReplicatedStorage:WaitForChild("Shared")
S.Utils = S.ReplicatedStorage:WaitForChild("Utils")

S.Synchronizer = require(S.Packages:WaitForChild("Synchronizer"))
S.AnimalsData = require(S.Datas:WaitForChild("Animals"))
S.RaritiesData = require(S.Datas:WaitForChild("Rarities"))
S.AnimalsShared = require(S.Shared:WaitForChild("Animals"))
S.NumberUtils = require(S.Utils:WaitForChild("NumberUtils"))

S.LocalPlayer = S.Players.LocalPlayer
S.PlayerGui = S.LocalPlayer:WaitForChild("PlayerGui")

-- Device detection
local isMobile = S.UserInputService.TouchEnabled and not S.UserInputService.KeyboardEnabled
local isTablet = S.UserInputService.TouchEnabled and workspace.CurrentCamera.ViewportSize.X >= 768

-- Nexa User Detection
local NEXA_USERS = {}
local NEXA_TAGS = {}

-- ============================================================
-- SECTION 3: GLOBAL STATE
-- ============================================================

local screenGui, mainFrame, contentFrame
local allAnimalsCache = {}
local guiVisible = true
local currentCategory = "steal"
local searchQuery = ""
local isCloning = false
local highestAnimal = nil
local statLabels = nil

local ESP_INSTANCES = {}
local PLAYER_ESP = {}
local ESP_BEST_UID = nil

local stats = {
    totalAnimals = 0,
    totalValue = 0,
    highestGen = 0,
    mutationCount = 0,
    traitCount = 0,
}

local scannerConnections = {}
local plotChannels = {}
local lastAnimalData = {}

local floatPlatform = nil
local invisibleWallsLoaded = false
local originalTransparency = {}

local InternalStealCache = {}
local AUTO_STEAL_PROX_RADIUS = 20
local PromptMemoryCache = {}
local LastTargetUID = nil
local LastPlayerPosition = nil
local PlayerVelocity = Vector3.zero
local PREDICTION_LOOKAHEAD = 1.25

local STEAL_SPEED = 25.5
local stealSpeedConn = nil

local tweenInfoFast = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
local tweenInfoMedium = TweenInfo.new(0.4, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)

local stealConnection = nil
local velocityConnection = nil

-- Anti-ragdoll vars
local antiRagdollMode = nil
local ragdollConnections = {}
local cachedCharData = {}

-- Optimizer vars
local optimizerThreads = {}
local optimizerConnections = {}
local originalSettings = {}

-- Anti-lag vars
local antiLagRunning = false
local antiLagConnections = {}
local cleanedCharacters = {}

-- Anti-bee/disco vars
local antiBeeDiscoRunning = false
local antiBeeDiscoConnections = {}
local originalMoveFunction = nil
local controlsProtected = false

local FOV_MANAGER = {
    activeCount = 0,
    conn = nil,
    forcedFOV = 70,
}

function FOV_MANAGER:Start()
    if self.conn then return end
    self.conn = S.RunService.RenderStepped:Connect(function()
        local cam = workspace.CurrentCamera
        if cam and cam.FieldOfView ~= self.forcedFOV then
            cam.FieldOfView = self.forcedFOV
        end
    end)
end

function FOV_MANAGER:Stop()
    if self.conn then
        self.conn:Disconnect()
        self.conn = nil
    end
end

function FOV_MANAGER:Push()
    self.activeCount += 1
    self:Start()
end

function FOV_MANAGER:Pop()
    if self.activeCount > 0 then
        self.activeCount -= 1
    end
    if self.activeCount == 0 then
        self:Stop()
    end
end

-- ============================================================
-- SECTION 4: HELPER FUNCTIONS
-- ============================================================

local function createElement(className, properties)
    local el = Instance.new(className)
    for k, v in pairs(properties) do
        el[k] = v
    end
    return el
end

local function tween(el, info, props)
    S.TweenService:Create(el, info, props):Play()
end

local function showNotification(message, color)
    color = color or COLORS.Success
    print("[Nexa Cheats]", message)
end

local function saveConfig()
    local serializableConfig = {}
    for k, v in pairs(CONFIG) do
        if typeof(v) == "EnumItem" then
            serializableConfig[k] = {
                _type = "EnumItem",
                _enumType = tostring(v.EnumType),
                _name = v.Name
            }
        else
            serializableConfig[k] = v
        end
    end
    local success, jsonData = pcall(S.HttpService.JSONEncode, S.HttpService, serializableConfig)
    if success then
        writefile(Config.CONFIG_FILE_NAME, jsonData)
    end
end

local function loadConfig()
    if not isfile(Config.CONFIG_FILE_NAME) then return end
    local success, jsonData = pcall(readfile, Config.CONFIG_FILE_NAME)
    if not success then return end
    local success2, savedConfig = pcall(S.HttpService.JSONDecode, S.HttpService, jsonData)
    if success2 and savedConfig then
        for k, v in pairs(savedConfig) do
            if type(v) == "table" and v._type == "EnumItem" then
                if v._enumType == "KeyCode" and Enum.KeyCode[v._name] then
                    CONFIG[k] = Enum.KeyCode[v._name]
                end
            else
                CONFIG[k] = v
            end
        end
        getgenv().BRAINROT_CONFIG = CONFIG
    end
end

local function saveFavorites()
    local success, jsonData = pcall(S.HttpService.JSONEncode, S.HttpService, FAVORITES)
    if success then
        writefile(Config.FAVORITES_FILE, jsonData)
    end
end

local function loadFavorites()
    if not isfile(Config.FAVORITES_FILE) then return end
    local success, jsonData = pcall(readfile, Config.FAVORITES_FILE)
    if not success then return end
    local success2, savedFavorites = pcall(S.HttpService.JSONDecode, S.HttpService, jsonData)
    if success2 and savedFavorites then
        for _, name in ipairs(savedFavorites) do
            table.insert(FAVORITES, name)
        end
        getgenv().BRAINROT_FAVORITES = FAVORITES
    end
end

-- ============================================================
-- SECTION 5: NEXA USER DETECTION SYSTEM
-- ============================================================

local function broadcastNexaUser()
    -- Broadcast that we're using Nexa
    if not getgenv().NEXA_USER_BROADCAST then
        getgenv().NEXA_USER_BROADCAST = true
    end
end

local function isNexaUser(player)
    if player == S.LocalPlayer then return false end
    
    -- Check if they have Nexa broadcast flag
    local success, result = pcall(function()
        return player:FindFirstChild("NEXA_USER_MARKER")
    end)
    
    return success and result
end

local function createNexaTag(player)
    if NEXA_TAGS[player] then return end
    
    local character = player.Character
    if not character then return end
    
    local hrp = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("UpperTorso")
    if not hrp then return end
    
    -- Create billboard
    local billboard = createElement("BillboardGui", {
        Name = "NexaTag",
        Adornee = hrp,
        Size = UDim2.new(0, 200, 0, 50),
        StudsOffset = Vector3.new(0, 4, 0),
        AlwaysOnTop = true,
        Parent = screenGui,
    })
    
    -- Background frame
    local bgFrame = createElement("Frame", {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundColor3 = COLORS.Primary,
        BackgroundTransparency = 0.3,
        BorderSizePixel = 0,
        Parent = billboard,
    })
    
    createElement("UICorner", {
        CornerRadius = UDim.new(0, 10),
        Parent = bgFrame,
    })
    
    createElement("UIStroke", {
        Color = COLORS.Primary,
        Thickness = 2,
        Transparency = 0.2,
        Parent = bgFrame,
    })
    
    -- Nexa text
    local nexaLabel = createElement("TextLabel", {
        Size = UDim2.new(1, 0, 0.6, 0),
        Position = UDim2.new(0, 0, 0, 0),
        BackgroundTransparency = 1,
        Text = "ðŸ”¥ NEXA USER",
        TextColor3 = Color3.fromRGB(255, 255, 255),
        TextSize = 16,
        Font = Enum.Font.GothamBold,
        TextStrokeTransparency = 0.5,
        Parent = bgFrame,
    })
    
    -- Player name
    local nameLabel = createElement("TextLabel", {
        Size = UDim2.new(1, 0, 0.4, 0),
        Position = UDim2.new(0, 0, 0.6, 0),
        BackgroundTransparency = 1,
        Text = player.Name,
        TextColor3 = Color3.fromRGB(200, 255, 200),
        TextSize = 12,
        Font = Enum.Font.Gotham,
        Parent = bgFrame,
    })
    
    -- Green highlight on character
    local highlight = createElement("Highlight", {
        Name = "NexaHighlight",
        Adornee = character,
        FillColor = COLORS.Primary,
        FillTransparency = 0.7,
        OutlineColor = COLORS.Primary,
        OutlineTransparency = 0.3,
        DepthMode = Enum.HighlightDepthMode.AlwaysOnTop,
        Parent = character,
    })
    
    -- Pulsing animation
    task.spawn(function()
        while billboard.Parent and highlight.Parent do
            tween(highlight, TweenInfo.new(1, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), {
                FillTransparency = 0.5,
            })
            task.wait(1)
            tween(highlight, TweenInfo.new(1, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), {
                FillTransparency = 0.7,
            })
            task.wait(1)
        end
    end)
    
    NEXA_TAGS[player] = {
        billboard = billboard,
        highlight = highlight,
    }
end

local function removeNexaTag(player)
    local tag = NEXA_TAGS[player]
    if not tag then return end
    
    if tag.billboard then
        tag.billboard:Destroy()
    end
    if tag.highlight then
        tag.highlight:Destroy()
    end
    
    NEXA_TAGS[player] = nil
end

local function scanForNexaUsers()
    for _, player in ipairs(S.Players:GetPlayers()) do
        if player ~= S.LocalPlayer then
            local character = player.Character
            if character then
                -- Check if they're using Nexa by looking for specific GUI
                local playerGui = player:FindFirstChild("PlayerGui")
                if playerGui then
                    local nexaGui = playerGui:FindFirstChild("NexaCheats")
                    if nexaGui and not NEXA_TAGS[player] then
                        createNexaTag(player)
                        NEXA_USERS[player] = true
                        showNotification("ðŸ”¥ Nexa User Detected: " .. player.Name, COLORS.Success)
                    elseif not nexaGui and NEXA_TAGS[player] then
                        removeNexaTag(player)
                        NEXA_USERS[player] = nil
                    end
                end
            end
        end
    end
end

local function setupNexaDetection()
    -- Create a marker on local player to identify as Nexa user
    local marker = createElement("BoolValue", {
        Name = "NEXA_USER_MARKER",
        Value = true,
        Parent = S.LocalPlayer,
    })
    
    -- Broadcast to getgenv
    broadcastNexaUser()
    
    -- Monitor all players
    S.Players.PlayerAdded:Connect(function(player)
        task.wait(2) -- Wait for them to load
        
        player.CharacterAdded:Connect(function(character)
            task.wait(1)
            scanForNexaUsers()
        end)
        
        if player.Character then
            task.wait(1)
            scanForNexaUsers()
        end
    end)
    
    S.Players.PlayerRemoving:Connect(function(player)
        removeNexaTag(player)
        NEXA_USERS[player] = nil
    end)
    
    -- Check existing players
    for _, player in ipairs(S.Players:GetPlayers()) do
        if player ~= S.LocalPlayer and player.Character then
            task.spawn(function()
                task.wait(1)
                scanForNexaUsers()
            end)
        end
        
        player.CharacterAdded:Connect(function(character)
            task.wait(1)
            scanForNexaUsers()
        end)
    end
    
    -- Periodic scan every 5 seconds
    task.spawn(function()
        while task.wait(5) do
            scanForNexaUsers()
        end
    end)
end

-- ============================================================
-- SECTION 6: CORE GAME FUNCTIONS
-- ============================================================

local function getHRP()
    local c = S.LocalPlayer.Character
    if not c then return end
    return c:FindFirstChild("HumanoidRootPart") or c:FindFirstChild("UpperTorso")
end

local function isMyBaseAnimal(animalData)
    if not animalData or not animalData.plot then return false end
    local plots = workspace:FindFirstChild("Plots")
    if not plots then return false end
    local plot = plots:FindFirstChild(animalData.plot)
    if not plot then return false end
    
    local channel = S.Synchronizer:Get(plot.Name)
    if channel then
        local owner = channel:Get("Owner")
        if owner then
            if typeof(owner) == "Instance" and owner:IsA("Player") then
                return owner.UserId == S.LocalPlayer.UserId
            elseif typeof(owner) == "table" and owner.UserId then
                return owner.UserId == S.LocalPlayer.UserId
            elseif typeof(owner) == "Instance" then
                return owner == S.LocalPlayer
            end
        end
    end
    
    local sign = plot:FindFirstChild("PlotSign")
    if sign then
        local yourBase = sign:FindFirstChild("YourBase")
        if yourBase and yourBase:IsA("BillboardGui") then
            return yourBase.Enabled == true
        end
    end
    
    return false
end

local function getAnimalPosition(animalData)
    local plot = workspace.Plots:FindFirstChild(animalData.plot)
    if not plot then return nil end
    local podiums = plot:FindFirstChild("AnimalPodiums")
    if not podiums then return nil end
    local podium = podiums:FindFirstChild(animalData.slot)
    if not podium then return nil end
    return podium:GetPivot().Position
end

local function getNearestAnimal()
    local hrp = getHRP()
    if not hrp then return nil end
    local nearest = nil
    local minDist = math.huge
    
    for _, animalData in ipairs(allAnimalsCache) do
        if isMyBaseAnimal(animalData) then continue end
        local pos = getAnimalPosition(animalData)
        if pos then
            local dist = (hrp.Position - pos).Magnitude
            if dist < minDist then
                minDist = dist
                nearest = animalData
            end
        end
    end
    
    return nearest
end

local function getPriorityAnimal()
    for _, priorityName in ipairs(PRIORITY_ANIMALS) do
        for _, animalData in ipairs(allAnimalsCache) do
            if not isMyBaseAnimal(animalData) and animalData.name == priorityName then
                return animalData
            end
        end
    end
    return nil
end

local function findProximityPromptForAnimal(animalData)
    if not animalData then return nil end
    local cachedPrompt = PromptMemoryCache[animalData.uid]
    if cachedPrompt and cachedPrompt.Parent then
        return cachedPrompt
    end
    
    local plot = workspace.Plots:FindFirstChild(animalData.plot)
    if not plot then return nil end
    local podiums = plot:FindFirstChild("AnimalPodiums")
    if not podiums then return nil end
    local podium = podiums:FindFirstChild(animalData.slot)
    if not podium then return nil end
    local base = podium:FindFirstChild("Base")
    if not base then return nil end
    local spawn = base:FindFirstChild("Spawn")
    if not spawn then return nil end
    local attach = spawn:FindFirstChild("PromptAttachment")
    if not attach then return nil end
    
    for _, p in ipairs(attach:GetChildren()) do
        if p:IsA("ProximityPrompt") then
            PromptMemoryCache[animalData.uid] = p
            return p
        end
    end
    
    return nil
end

local function updatePlayerVelocity()
    local hrp = getHRP()
    if not hrp then return end
    local currentPos = hrp.Position
    if LastPlayerPosition then
        PlayerVelocity = (currentPos - LastPlayerPosition) / task.wait()
    end
    LastPlayerPosition = currentPos
end

local function getTimeToReach(targetPos)
    local hrp = getHRP()
    if not hrp then return math.huge end
    local currentPos = hrp.Position
    local distance = (targetPos - currentPos).Magnitude
    if PlayerVelocity.Magnitude < 0.1 then return math.huge end
    local directionToTarget = (targetPos - currentPos).Unit
    local velocityTowardTarget = PlayerVelocity:Dot(directionToTarget)
    if velocityTowardTarget <= 0 then return math.huge end
    return distance / velocityTowardTarget
end

local function shouldPreFire(animalData)
    local animalPos = getAnimalPosition(animalData)
    if not animalPos then return false end
    local hrp = getHRP()
    if not hrp then return false end
    local currentDistance = (hrp.Position - animalPos).Magnitude
    if currentDistance <= AUTO_STEAL_PROX_RADIUS then return true end
    if not CONFIG.PREDICTIVE_STEAL then return false end
    local timeToReach = getTimeToReach(animalPos)
    if timeToReach <= PREDICTION_LOOKAHEAD and timeToReach > 0 then return true end
    return false
end

local function buildStealCallbacks(prompt)
    if InternalStealCache[prompt] then return end
    local data = { holdCallbacks = {}, triggerCallbacks = {}, ready = true }
    
    local ok1, conns1 = pcall(getconnections, prompt.PromptButtonHoldBegan)
    if ok1 and type(conns1) == "table" then
        for _, conn in ipairs(conns1) do
            if type(conn.Function) == "function" then
                table.insert(data.holdCallbacks, conn.Function)
            end
        end
    end
    
    local ok2, conns2 = pcall(getconnections, prompt.Triggered)
    if ok2 and type(conns2) == "table" then
        for _, conn in ipairs(conns2) do
            if type(conn.Function) == "function" then
                table.insert(data.triggerCallbacks, conn.Function)
            end
        end
    end
    
    if (#data.holdCallbacks > 0) or (#data.triggerCallbacks > 0) then
        InternalStealCache[prompt] = data
    end
end

local function runCallbackList(list)
    for _, fn in ipairs(list) do
        task.spawn(fn)
    end
end

local function executeInternalStealAsync(prompt)
    local data = InternalStealCache[prompt]
    if not data or not data.ready then return false end
    data.ready = false
    
    task.spawn(function()
        if #data.holdCallbacks > 0 then
            runCallbackList(data.holdCallbacks)
        end
        task.wait(1.3)
        if #data.triggerCallbacks > 0 then
            runCallbackList(data.triggerCallbacks)
        end
        task.wait()
        data.ready = true
    end)
    
    return true
end

local function attemptSteal(prompt)
    if not prompt or not prompt.Parent then return false end
    buildStealCallbacks(prompt)
    if not InternalStealCache[prompt] then return false end
    return executeInternalStealAsync(prompt)
end

local function autoStealLoop()
    if stealConnection then stealConnection:Disconnect() end
    if velocityConnection then velocityConnection:Disconnect() end
    
    velocityConnection = S.RunService.Heartbeat:Connect(function()
        updatePlayerVelocity()
    end)
    
    stealConnection = S.RunService.Heartbeat:Connect(function()
        if not CONFIG.AUTO_STEAL_ENABLED and not CONFIG.AUTO_STEAL_NEAREST_ENABLED and not CONFIG.AUTO_STEAL_PRIORITY_ENABLED then
            return
        end
        
        local targetAnimal = nil
        
        if CONFIG.AUTO_STEAL_PRIORITY_ENABLED then
            targetAnimal = getPriorityAnimal()
            if not targetAnimal then
                if CONFIG.AUTO_STEAL_NEAREST_ENABLED then
                    targetAnimal = getNearestAnimal()
                elseif CONFIG.AUTO_STEAL_ENABLED then
                    for _, animal in ipairs(allAnimalsCache) do
                        if not isMyBaseAnimal(animal) then
                            targetAnimal = animal
                            break
                        end
                    end
                end
            end
        elseif CONFIG.AUTO_STEAL_NEAREST_ENABLED then
            targetAnimal = getNearestAnimal()
        elseif CONFIG.AUTO_STEAL_ENABLED then
            for _, animal in ipairs(allAnimalsCache) do
                if not isMyBaseAnimal(animal) then
                    targetAnimal = animal
                    break
                end
            end
        end
        
        if not targetAnimal or isMyBaseAnimal(targetAnimal) then return end
        if not shouldPreFire(targetAnimal) then return end
        if LastTargetUID ~= targetAnimal.uid then
            LastTargetUID = targetAnimal.uid
        end
        
        local prompt = PromptMemoryCache[targetAnimal.uid]
        if not prompt or not prompt.Parent then
            prompt = findProximityPromptForAnimal(targetAnimal)
        end
        
        if prompt then
            attemptSteal(prompt)
        end
    end)
end

local function teleportToAnimal(animalData)
    local character = S.LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then
        showNotification("Character not found!", COLORS.Warning)
        return false
    end
    
    local humanoid = character:FindFirstChild("Humanoid")
    local hrp = character.HumanoidRootPart
    if not humanoid or not hrp then return false end
    
    local plot = workspace.Plots:FindFirstChild(animalData.plot)
    if not plot then
        showNotification("Plot not found!", COLORS.Warning)
        return false
    end
    
    local targetPos = Vector3.new(0, 10, 0)
    local podiums = plot:FindFirstChild("AnimalPodiums")
    local animalFolder = podiums and podiums:FindFirstChild(animalData.slot)
    
    if animalFolder then
        local allParts = {}
        local function scan(obj)
            for _, child in ipairs(obj:GetChildren()) do
                if child:IsA("BasePart") then
                    table.insert(allParts, child)
                else
                    scan(child)
                end
            end
        end
        scan(animalFolder)
        
        if #allParts > 0 then
            local closest, minDist = nil, math.huge
            for _, part in ipairs(allParts) do
                local dist = (part.Position - hrp.Position).Magnitude
                if dist < minDist then
                    minDist = dist
                    closest = part
                end
            end
            if closest then
                targetPos = closest.Position
            end
        end
    end
    
    hrp.CFrame = CFrame.new(targetPos)
    showNotification("Teleported to " .. animalData.name, COLORS.Success)
    return true
end

local function teleportToHighest()
    if #allAnimalsCache == 0 then
        showNotification("No brainrots found yet!", COLORS.Warning)
        return
    end
    
    if CONFIG.FAVORITES_PRIORITY_ENABLED and #FAVORITES > 0 then
        local favAnimal = nil
        for _, favName in ipairs(FAVORITES) do
            for _, animal in ipairs(allAnimalsCache) do
                if animal.name:lower() == favName:lower() then
                    favAnimal = animal
                    break
                end
            end
            if favAnimal then break end
        end
        
        if favAnimal then
            showNotification("Teleporting to priority: " .. favAnimal.name, COLORS.Success)
            teleportToAnimal(favAnimal)
            return
        end
    end
    
    teleportToAnimal(allAnimalsCache[1])
end

local function runDesyncEngine()
    for key, value in pairs(DESYNC_FLAGS) do
        pcall(function()
            setfflag(tostring(key), tostring(value))
        end)
    end
end

local function enableDesync()
    task.spawn(runDesyncEngine)
    showNotification("Desync V3 Enabled!", COLORS.Success)
end

local function instantCloner()
    if isCloning then
        showNotification("Cloner already in progress!", COLORS.Warning)
        return
    end
    
    isCloning = true
    
    local success, err = pcall(function()
        local character = S.LocalPlayer.Character
        if not character then error("Character not found") end
        
        local humanoid = character:FindFirstChild("Humanoid")
        if not humanoid then error("Humanoid not found") end
        
        for _, tool in ipairs(character:GetChildren()) do
            if tool:IsA("Tool") then
                humanoid:UnequipTools()
                task.wait(0.1)
                break
            end
        end
        
        local backpack = S.LocalPlayer.Backpack
        local cloner = backpack:FindFirstChild("Quantum Cloner")
        if not cloner then error("Quantum Cloner not found in inventory!") end
        
        humanoid:EquipTool(cloner)
        task.wait()
        
        local useRemote = S.ReplicatedStorage:WaitForChild("Packages"):WaitForChild("Net"):WaitForChild("RE/UseItem")
        useRemote:FireServer()
        task.wait()
        
        local clonerRemote = S.ReplicatedStorage:WaitForChild("Packages"):WaitForChild("Net"):WaitForChild("RE/QuantumCloner/OnTeleport")
        clonerRemote:FireServer()
        
        showNotification("Instant Cloner Activated!", COLORS.Success)
    end)
    
    if not success then
        showNotification("Cloner Failed: " .. tostring(err), COLORS.Error)
    end
    
    task.wait(1)
    isCloning = false
end

local function kickSelf()
    showNotification("Kicking...", COLORS.Error)
    task.wait()
    S.LocalPlayer:Kick("Kicked by Nexa Cheats")
end

local function rejoinServer()
    local placeId = game.PlaceId
    local jobId = game.JobId
    
    showNotification("Rejoining current server...", COLORS.Success)
    
    task.delay(0.15, function()
        local ok, err = pcall(function()
            if jobId and jobId ~= "" then
                S.TeleportService:TeleportToPlaceInstance(placeId, jobId, S.LocalPlayer)
            else
                S.TeleportService:Teleport(placeId, S.LocalPlayer)
            end
        end)
        
        if not ok and err then
            showNotification("Rejoin failed: " .. tostring(err), COLORS.Error)
        end
    end)
end

local function startFloorSteal()
    if floatPlatform then floatPlatform:Destroy() end
    
    floatPlatform = Instance.new("Part")
    floatPlatform.Size = Vector3.new(6, 1, 6)
    floatPlatform.Anchored = true
    floatPlatform.CanCollide = true
    floatPlatform.Transparency = 1
    floatPlatform.Parent = workspace
    
    task.spawn(function()
        while CONFIG.FLOOR_STEAL_ENABLED and floatPlatform do
            local hrp = getHRP()
            if hrp then
                floatPlatform.Position = hrp.Position - Vector3.new(0, 3, 0)
            end
            task.wait(0.05)
        end
    end)
end

local function stopFloorSteal()
    if floatPlatform then
        floatPlatform:Destroy()
        floatPlatform = nil
    end
end

-- ============================================================
-- SECTION
