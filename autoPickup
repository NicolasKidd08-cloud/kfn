--[[
    Modern Brainrot Hub
    Stolen features from BK's Hub v2.5 but with a cleaner UI
]]

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Game modules
local Packages = ReplicatedStorage:WaitForChild("Packages")
local Datas = ReplicatedStorage:WaitForChild("Datas")
local Shared = ReplicatedStorage:WaitForChild("Shared")
local Utils = ReplicatedStorage:WaitForChild("Utils")

local Synchronizer = require(Packages:WaitForChild("Synchronizer"))
local AnimalsData = require(Datas:WaitForChild("Animals"))
local RaritiesData = require(Datas:WaitForChild("Rarities"))
local AnimalsShared = require(Shared:WaitForChild("Animals"))
local NumberUtils = require(Utils:WaitForChild("NumberUtils"))

-- Config
local Config = {
    AutoStealEnabled = false,
    AutoStealNearest = false,
    DesyncEnabled = false,
    ESPEnabled = false,
    AntiRagdollEnabled = false,
    FloorStealEnabled = false,
    SpeedBoostEnabled = false,
}

-- DESYNC FLAGS (Stolen from BK's Hub)
local DESYNC_FLAGS = {
    LargeReplicatorEnabled9 = true,
    GameNetDontSendRedundantNumTimes = 1,
    MaxTimestepMultiplierAcceleration = 2147483647,
    InterpolationFrameVelocityThresholdMillionth = 5,
    CheckPVDifferencesForInterpolationMinRotVelThresholdRadsPerSecHundredth = 1,
    TimestepArbiterVelocityCriteriaThresholdTwoDt = 2147483646,
    GameNetPVHeaderLinearVelocityZeroCutoffExponent = -5000,
    TimestepArbiterHumanoidTurningVelThreshold = 1,
    LargeReplicatorSerializeWrite4 = true,
    SimExplicitlyCappedTimestepMultiplier = 2147483646,
    InterpolationFrameRotVelocityThresholdMillionth = 5,
    ServerMaxBandwith = 52,
}

-- GUI Creation
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "NexaHub"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.Parent = PlayerGui

-- Main Frame with much brighter colors
local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 420, 0, 550)
MainFrame.Position = UDim2.new(0.5, -210, 0.5, -275)
MainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui

-- Rounded corners
local MainCorner = Instance.new("UICorner")
MainCorner.CornerRadius = UDim.new(0, 15)
MainCorner.Parent = MainFrame

-- Much brighter glowing border
local MainStroke = Instance.new("UIStroke")
MainStroke.Color = Color3.fromRGB(180, 80, 255)
MainStroke.Thickness = 3
MainStroke.Transparency = 0
MainStroke.Parent = MainFrame

-- Animated gradient for stroke
local StrokeGradient = Instance.new("UIGradient")
StrokeGradient.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0, Color3.fromRGB(180, 80, 255)),
    ColorSequenceKeypoint.new(0.5, Color3.fromRGB(255, 120, 255)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(180, 80, 255))
})
StrokeGradient.Parent = MainStroke

-- Animate the stroke gradient
task.spawn(function()
    while MainFrame.Parent do
        for i = 0, 360, 3 do
            if not MainFrame.Parent then break end
            StrokeGradient.Rotation = i
            task.wait(0.03)
        end
    end
end)

-- Header with bright background
local HeaderFrame = Instance.new("Frame")
HeaderFrame.Size = UDim2.new(1, 0, 0, 70)
HeaderFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 65)
HeaderFrame.BorderSizePixel = 0
HeaderFrame.Parent = MainFrame

Instance.new("UICorner", HeaderFrame).CornerRadius = UDim.new(0, 15)

-- Header bottom border
local HeaderBorder = Instance.new("Frame")
HeaderBorder.Size = UDim2.new(1, 0, 0, 2)
HeaderBorder.Position = UDim2.new(0, 0, 1, -2)
HeaderBorder.BackgroundColor3 = Color3.fromRGB(180, 80, 255)
HeaderBorder.BorderSizePixel = 0
HeaderBorder.Parent = HeaderFrame

-- Big visible title
local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, -20, 0, 30)
Title.Position = UDim2.new(0, 15, 0, 10)
Title.BackgroundTransparency = 1
Title.Text = "‚ö° NEXA HUB"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = 22
Title.Font = Enum.Font.GothamBold
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.TextStrokeTransparency = 0.5
Title.TextStrokeColor3 = Color3.fromRGB(180, 80, 255)
Title.Parent = HeaderFrame

-- Bright subtitle
local Subtitle = Instance.new("TextLabel")
Subtitle.Size = UDim2.new(1, -20, 0, 20)
Subtitle.Position = UDim2.new(0, 15, 0, 42)
Subtitle.BackgroundTransparency = 1
Subtitle.Text = "Premium Edition ‚Ä¢ v2.0"
Subtitle.TextColor3 = Color3.fromRGB(200, 200, 220)
Subtitle.TextSize = 14
Subtitle.Font = Enum.Font.GothamSemibold
Subtitle.TextXAlignment = Enum.TextXAlignment.Left
Subtitle.Parent = HeaderFrame

-- Bright status indicator
local StatusDot = Instance.new("Frame")
StatusDot.Size = UDim2.new(0, 10, 0, 10)
StatusDot.Position = UDim2.new(1, -20, 0, 25)
StatusDot.BackgroundColor3 = Color3.fromRGB(0, 255, 100)
StatusDot.BorderSizePixel = 0
StatusDot.Parent = HeaderFrame

Instance.new("UICorner", StatusDot).CornerRadius = UDim.new(1, 0)

-- Pulse animation
task.spawn(function()
    while StatusDot.Parent do
        TweenService:Create(StatusDot, TweenInfo.new(0.8, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), {
            BackgroundTransparency = 0.3
        }):Play()
        task.wait(0.8)
        TweenService:Create(StatusDot, TweenInfo.new(0.8, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), {
            BackgroundTransparency = 0
        }):Play()
        task.wait(0.8)
    end
end)

-- Brighter scroll frame
local ScrollFrame = Instance.new("ScrollingFrame")
ScrollFrame.Size = UDim2.new(1, -20, 1, -90)
ScrollFrame.Position = UDim2.new(0, 10, 0, 80)
ScrollFrame.BackgroundTransparency = 1
ScrollFrame.BorderSizePixel = 0
ScrollFrame.ScrollBarThickness = 6
ScrollFrame.ScrollBarImageColor3 = Color3.fromRGB(180, 80, 255)
ScrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
ScrollFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
ScrollFrame.ScrollingDirection = Enum.ScrollingDirection.Y
ScrollFrame.Parent = MainFrame

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.Padding = UDim.new(0, 10)
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Parent = ScrollFrame

-- Helper function to create toggles with BRIGHT visible styling and ON/OFF labels
local function CreateToggle(name, callback)
    local ToggleFrame = Instance.new("Frame")
    ToggleFrame.Size = UDim2.new(1, 0, 0, 50)
    ToggleFrame.BackgroundColor3 = Color3.fromRGB(55, 55, 70)
    ToggleFrame.BorderSizePixel = 0
    ToggleFrame.Parent = ScrollFrame
    
    local ToggleCorner = Instance.new("UICorner")
    ToggleCorner.CornerRadius = UDim.new(0, 10)
    ToggleCorner.Parent = ToggleFrame
    
    -- Bright visible border
    local ToggleBorder = Instance.new("UIStroke")
    ToggleBorder.Color = Color3.fromRGB(100, 100, 120)
    ToggleBorder.Thickness = 2
    ToggleBorder.Transparency = 0
    ToggleBorder.Parent = ToggleFrame
    
    -- Big visible label
    local Label = Instance.new("TextLabel")
    Label.Size = UDim2.new(0.5, 0, 1, 0)
    Label.Position = UDim2.new(0, 15, 0, 0)
    Label.BackgroundTransparency = 1
    Label.Text = name
    Label.TextColor3 = Color3.fromRGB(255, 255, 255)
    Label.TextSize = 16
    Label.Font = Enum.Font.GothamBold
    Label.TextXAlignment = Enum.TextXAlignment.Left
    Label.Parent = ToggleFrame
    
    -- ON/OFF Status Label
    local StatusLabel = Instance.new("TextLabel")
    StatusLabel.Size = UDim2.new(0, 40, 1, 0)
    StatusLabel.Position = UDim2.new(1, -120, 0, 0)
    StatusLabel.BackgroundTransparency = 1
    StatusLabel.Text = "OFF"
    StatusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
    StatusLabel.TextSize = 14
    StatusLabel.Font = Enum.Font.GothamBold
    StatusLabel.TextXAlignment = Enum.TextXAlignment.Right
    StatusLabel.Parent = ToggleFrame
    
    -- MUCH bigger and more visible toggle switch
    local ToggleBg = Instance.new("Frame")
    ToggleBg.Size = UDim2.new(0, 60, 0, 32)
    ToggleBg.Position = UDim2.new(1, -70, 0.5, -16)
    ToggleBg.BackgroundColor3 = Color3.fromRGB(80, 50, 50)
    ToggleBg.BorderSizePixel = 0
    ToggleBg.Parent = ToggleFrame
    
    Instance.new("UICorner", ToggleBg).CornerRadius = UDim.new(1, 0)
    
    -- Visible border for toggle
    local ToggleBgBorder = Instance.new("UIStroke")
    ToggleBgBorder.Color = Color3.fromRGB(255, 100, 100)
    ToggleBgBorder.Thickness = 2
    ToggleBgBorder.Parent = ToggleBg
    
    -- Big bright toggle circle
    local ToggleCircle = Instance.new("Frame")
    ToggleCircle.Size = UDim2.new(0, 26, 0, 26)
    ToggleCircle.Position = UDim2.new(0, 3, 0.5, -13)
    ToggleCircle.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    ToggleCircle.BorderSizePixel = 0
    ToggleCircle.Parent = ToggleBg
    
    Instance.new("UICorner", ToggleCircle).CornerRadius = UDim.new(1, 0)
    
    local Button = Instance.new("TextButton")
    Button.Size = UDim2.new(1, 0, 1, 0)
    Button.BackgroundTransparency = 1
    Button.Text = ""
    Button.Parent = ToggleFrame
    
    local enabled = false
    
    -- Hover effect - make it glow
    Button.MouseEnter:Connect(function()
        TweenService:Create(ToggleFrame, TweenInfo.new(0.2), {
            BackgroundColor3 = Color3.fromRGB(65, 65, 80)
        }):Play()
        TweenService:Create(ToggleBorder, TweenInfo.new(0.2), {
            Color = Color3.fromRGB(180, 80, 255)
        }):Play()
    end)
    
    Button.MouseLeave:Connect(function()
        TweenService:Create(ToggleFrame, TweenInfo.new(0.2), {
            BackgroundColor3 = Color3.fromRGB(55, 55, 70)
        }):Play()
        TweenService:Create(ToggleBorder, TweenInfo.new(0.2), {
            Color = Color3.fromRGB(100, 100, 120)
        }):Play()
    end)
    
    Button.MouseButton1Click:Connect(function()
        enabled = not enabled
        callback(enabled)
        
        if enabled then
            -- ENABLED STATE - GREEN
            StatusLabel.Text = "ON"
            TweenService:Create(StatusLabel, TweenInfo.new(0.3), {
                TextColor3 = Color3.fromRGB(100, 255, 100)
            }):Play()
            
            TweenService:Create(ToggleBg, TweenInfo.new(0.3), {
                BackgroundColor3 = Color3.fromRGB(50, 120, 50)
            }):Play()
            
            TweenService:Create(ToggleBgBorder, TweenInfo.new(0.3), {
                Color = Color3.fromRGB(100, 255, 100)
            }):Play()
            
            TweenService:Create(Label, TweenInfo.new(0.3), {
                TextColor3 = Color3.fromRGB(200, 255, 200)
            }):Play()
        else
            -- DISABLED STATE - RED
            StatusLabel.Text = "OFF"
            TweenService:Create(StatusLabel, TweenInfo.new(0.3), {
                TextColor3 = Color3.fromRGB(255, 100, 100)
            }):Play()
            
            TweenService:Create(ToggleBg, TweenInfo.new(0.3), {
                BackgroundColor3 = Color3.fromRGB(80, 50, 50)
            }):Play()
            
            TweenService:Create(ToggleBgBorder, TweenInfo.new(0.3), {
                Color = Color3.fromRGB(255, 100, 100)
            }):Play()
            
            TweenService:Create(Label, TweenInfo.new(0.3), {
                TextColor3 = Color3.fromRGB(255, 255, 255)
            }):Play()
        end
        
        -- Move circle
        TweenService:Create(ToggleCircle, TweenInfo.new(0.3), {
            Position = enabled and UDim2.new(0, 31, 0.5, -13) or UDim2.new(0, 3, 0.5, -13)
        }):Play()
    end)
    
    return ToggleFrame
end

-- Helper function for action buttons - BRIGHT AND VISIBLE
local function CreateButton(name, color, callback)
    local ButtonFrame = Instance.new("TextButton")
    ButtonFrame.Size = UDim2.new(1, 0, 0, 48)
    ButtonFrame.BackgroundColor3 = color
    ButtonFrame.BorderSizePixel = 0
    ButtonFrame.Text = ""
    ButtonFrame.AutoButtonColor = false
    ButtonFrame.Parent = ScrollFrame
    
    local ButtonCorner = Instance.new("UICorner")
    ButtonCorner.CornerRadius = UDim.new(0, 10)
    ButtonCorner.Parent = ButtonFrame
    
    -- Bright visible border
    local ButtonStroke = Instance.new("UIStroke")
    ButtonStroke.Color = Color3.fromRGB(255, 255, 255)
    ButtonStroke.Thickness = 2
    ButtonStroke.Transparency = 0.5
    ButtonStroke.Parent = ButtonFrame
    
    -- Big bright text
    local ButtonText = Instance.new("TextLabel")
    ButtonText.Size = UDim2.new(1, 0, 1, 0)
    ButtonText.BackgroundTransparency = 1
    ButtonText.Text = name
    ButtonText.TextColor3 = Color3.fromRGB(255, 255, 255)
    ButtonText.TextSize = 17
    ButtonText.Font = Enum.Font.GothamBold
    ButtonText.TextStrokeTransparency = 0.5
    ButtonText.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    ButtonText.Parent = ButtonFrame
    
    -- Hover effects - make it glow bright
    ButtonFrame.MouseEnter:Connect(function()
        TweenService:Create(ButtonFrame, TweenInfo.new(0.2), {
            Size = UDim2.new(1, 0, 0, 52)
        }):Play()
        TweenService:Create(ButtonStroke, TweenInfo.new(0.2), {
            Transparency = 0.2,
            Thickness = 3
        }):Play()
        TweenService:Create(ButtonText, TweenInfo.new(0.2), {
            TextSize = 18
        }):Play()
    end)
    
    ButtonFrame.MouseLeave:Connect(function()
        TweenService:Create(ButtonFrame, TweenInfo.new(0.2), {
            Size = UDim2.new(1, 0, 0, 48)
        }):Play()
        TweenService:Create(ButtonStroke, TweenInfo.new(0.2), {
            Transparency = 0.5,
            Thickness = 2
        }):Play()
        TweenService:Create(ButtonText, TweenInfo.new(0.2), {
            TextSize = 17
        }):Play()
    end)
    
    -- Click animation
    ButtonFrame.MouseButton1Click:Connect(function()
        -- Quick press animation
        TweenService:Create(ButtonFrame, TweenInfo.new(0.1), {
            Size = UDim2.new(1, 0, 0, 45)
        }):Play()
        task.wait(0.1)
        TweenService:Create(ButtonFrame, TweenInfo.new(0.1), {
            Size = UDim2.new(1, 0, 0, 48)
        }):Play()
        
        callback()
    end)
    
    return ButtonFrame
end

-- ============================================================
-- DESYNC SYSTEM (Stolen from BK's Hub) - TOGGLEABLE
-- ============================================================

local DesyncIndicator = nil
local OriginalFlags = {}

local function EnableDesync()
    if Config.DesyncEnabled then return end
    
    Config.DesyncEnabled = true
    
    -- Store original flags
    for key, value in pairs(DESYNC_FLAGS) do
        pcall(function()
            local success, original = pcall(function()
                return getfflag(tostring(key))
            end)
            if success then
                OriginalFlags[key] = original
            end
        end)
    end
    
    -- Apply desync flags
    for key, value in pairs(DESYNC_FLAGS) do
        pcall(function()
            setfflag(tostring(key), tostring(value))
        end)
    end
    
    -- Create indicator
    DesyncIndicator = Instance.new("Frame")
    DesyncIndicator.Size = UDim2.new(0, 200, 0, 50)
    DesyncIndicator.Position = UDim2.new(0.5, -100, 0, 100)
    DesyncIndicator.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
    DesyncIndicator.BorderSizePixel = 0
    DesyncIndicator.Parent = ScreenGui
    
    Instance.new("UICorner", DesyncIndicator).CornerRadius = UDim.new(0, 10)
    
    local IndicatorStroke = Instance.new("UIStroke")
    IndicatorStroke.Color = Color3.fromRGB(138, 43, 226)
    IndicatorStroke.Thickness = 2
    IndicatorStroke.Parent = DesyncIndicator
    
    local IndicatorText = Instance.new("TextLabel")
    IndicatorText.Size = UDim2.new(1, 0, 1, 0)
    IndicatorText.BackgroundTransparency = 1
    IndicatorText.Text = "‚ö° DESYNC V3 ACTIVE"
    IndicatorText.TextColor3 = Color3.fromRGB(138, 43, 226)
    IndicatorText.TextSize = 14
    IndicatorText.Font = Enum.Font.GothamBold
    IndicatorText.Parent = DesyncIndicator
    
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "Desync Enabled";
        Text = "No lagback active";
        Duration = 3;
    })
end

local function DisableDesync()
    if not Config.DesyncEnabled then return end
    
    Config.DesyncEnabled = false
    
    -- Restore original flags
    for key, original in pairs(OriginalFlags) do
        pcall(function()
            setfflag(tostring(key), tostring(original))
        end)
    end
    
    OriginalFlags = {}
    
    -- Remove indicator
    if DesyncIndicator then
        DesyncIndicator:Destroy()
        DesyncIndicator = nil
    end
    
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "Desync Disabled";
        Text = "Flags restored";
        Duration = 3;
    })
end

-- ============================================================
-- AUTO STEAL SYSTEM (Stolen from BK's Hub) - FIXED WITH ANIMAL SCANNING
-- ============================================================

local PromptCache = {}
local InternalStealCache = {}
local AllAnimalsCache = {}

local function GetHRP()
    local char = LocalPlayer.Character
    if not char then return nil end
    return char:FindFirstChild("HumanoidRootPart")
end

local function IsMyBaseAnimal(animalData)
    if not animalData or not animalData.plot then
        return false
    end
    
    local plots = workspace:FindFirstChild("Plots")
    if not plots then
        return false
    end
    
    local plot = plots:FindFirstChild(animalData.plot)
    if not plot then
        return false
    end
    
    -- Use Synchronizer to check owner
    local channel = Synchronizer:Get(plot.Name)
    if channel then
        local owner = channel:Get("Owner")
        if owner then
            if typeof(owner) == "Instance" and owner:IsA("Player") then
                return owner.UserId == LocalPlayer.UserId
            elseif typeof(owner) == "table" and owner.UserId then
                return owner.UserId == LocalPlayer.UserId
            elseif typeof(owner) == "Instance" then
                return owner == LocalPlayer
            end
        end
    end
    
    return false
end

local function ScanAllAnimals()
    AllAnimalsCache = {}
    
    local plots = workspace:FindFirstChild("Plots")
    if not plots then return end
    
    for _, plot in ipairs(plots:GetChildren()) do
        local channel = Synchronizer:Get(plot.Name)
        if not channel then continue end
        
        local animalList = channel:Get("AnimalList")
        if not animalList then continue end
        
        local owner = channel:Get("Owner")
        if not owner or not Players:FindFirstChild(owner.Name) then continue end
        
        for slot, animalData in pairs(animalList) do
            if type(animalData) == "table" then
                local animalName = animalData.Index
                local animalInfo = AnimalsData[animalName]
                if not animalInfo then continue end
                
                local mutation = animalData.Mutation or "None"
                local traits = animalData.Traits or {}
                
                local genValue = AnimalsShared:GetGeneration(animalName, animalData.Mutation, animalData.Traits, nil)
                
                local data = {
                    name = animalInfo.DisplayName or animalName,
                    genValue = genValue,
                    owner = owner.Name,
                    plot = plot.Name,
                    slot = tostring(slot),
                    uid = plot.Name .. "_" .. tostring(slot),
                }
                
                -- Don't add your own base animals
                if not IsMyBaseAnimal(data) then
                    table.insert(AllAnimalsCache, data)
                end
            end
        end
    end
    
    -- Sort by gen value (highest first)
    table.sort(AllAnimalsCache, function(a, b)
        return a.genValue > b.genValue
    end)
end

local function GetAnimalPosition(animalData)
    local plots = workspace:FindFirstChild("Plots")
    if not plots then return nil end
    
    local plot = plots:FindFirstChild(animalData.plot)
    if not plot then return nil end
    
    local podiums = plot:FindFirstChild("AnimalPodiums")
    if not podiums then return nil end
    
    local podium = podiums:FindFirstChild(animalData.slot)
    if not podium then return nil end
    
    return podium:GetPivot().Position
end

local function GetNearestAnimal()
    local hrp = GetHRP()
    if not hrp then return nil end
    
    local nearest = nil
    local minDist = math.huge
    
    for _, animalData in ipairs(AllAnimalsCache) do
        local pos = GetAnimalPosition(animalData)
        if pos then
            local dist = (hrp.Position - pos).Magnitude
            
            if dist < minDist then
                minDist = dist
                nearest = animalData
            end
        end
    end
    
    return nearest
end

local function FindProximityPromptForAnimal(animalData)
    if not animalData then return nil end
    
    -- Check cache
    local cachedPrompt = PromptCache[animalData.uid]
    if cachedPrompt and cachedPrompt.Parent then
        return cachedPrompt
    end
    
    local plots = workspace:FindFirstChild("Plots")
    if not plots then return nil end
    
    local plot = plots:FindFirstChild(animalData.plot)
    if not plot then return nil end
    
    local podiums = plot:FindFirstChild("AnimalPodiums")
    if not podiums then return nil end
    
    local podium = podiums:FindFirstChild(animalData.slot)
    if not podium then return nil end
    
    local base = podium:FindFirstChild("Base")
    if not base then return nil end
    
    local spawn = base:FindFirstChild("Spawn")
    if not spawn then return nil end
    
    local attach = spawn:FindFirstChild("PromptAttachment")
    if not attach then return nil end
    
    for _, p in ipairs(attach:GetChildren()) do
        if p:IsA("ProximityPrompt") then
            PromptCache[animalData.uid] = p
            return p
        end
    end
    
    return nil
end

local function BuildStealCallbacks(prompt)
    if InternalStealCache[prompt] then return end
    
    local data = {
        holdCallbacks = {},
        triggerCallbacks = {},
        ready = true,
    }
    
    local ok1, conns1 = pcall(getconnections, prompt.PromptButtonHoldBegan)
    if ok1 and type(conns1) == "table" then
        for _, conn in ipairs(conns1) do
            if type(conn.Function) == "function" then
                table.insert(data.holdCallbacks, conn.Function)
            end
        end
    end
    
    local ok2, conns2 = pcall(getconnections, prompt.Triggered)
    if ok2 and type(conns2) == "table" then
        for _, conn in ipairs(conns2) do
            if type(conn.Function) == "function" then
                table.insert(data.triggerCallbacks, conn.Function)
            end
        end
    end
    
    if #data.holdCallbacks > 0 or #data.triggerCallbacks > 0 then
        InternalStealCache[prompt] = data
    end
end

local function ExecuteSteal(prompt)
    local data = InternalStealCache[prompt]
    if not data or not data.ready then return false end
    
    data.ready = false
    
    task.spawn(function()
        -- Execute hold callbacks
        for _, fn in ipairs(data.holdCallbacks) do
            task.spawn(fn)
        end
        
        task.wait(1.3)
        
        -- Execute trigger callbacks
        for _, fn in ipairs(data.triggerCallbacks) do
            task.spawn(fn)
        end
        
        task.wait(0.1)
        data.ready = true
    end)
    
    return true
end

local AutoStealConnection = nil
local LastScanTime = 0

local function StartAutoSteal()
    if AutoStealConnection then return end
    
    -- Initial scan
    ScanAllAnimals()
    
    AutoStealConnection = RunService.Heartbeat:Connect(function()
        if not Config.AutoStealEnabled then return end
        
        -- Rescan every 5 seconds
        local now = tick()
        if now - LastScanTime >= 5 then
            ScanAllAnimals()
            LastScanTime = now
        end
        
        local targetAnimal = nil
        
        if Config.AutoStealNearest then
            targetAnimal = GetNearestAnimal()
        else
            -- Get highest gen (first in sorted list)
            targetAnimal = AllAnimalsCache[1]
        end
        
        if not targetAnimal then return end
        
        -- Find proximity prompt
        local prompt = FindProximityPromptForAnimal(targetAnimal)
        
        if prompt then
            -- Build callbacks if not cached
            if not InternalStealCache[prompt] then
                BuildStealCallbacks(prompt)
            end
            
            -- Execute steal
            ExecuteSteal(prompt)
        end
    end)
    
    print("Auto-Steal started! Found " .. #AllAnimalsCache .. " animals")
end

local function StopAutoSteal()
    if AutoStealConnection then
        AutoStealConnection:Disconnect()
        AutoStealConnection = nil
    end
    print("Auto-Steal stopped!")
end

-- ============================================================
-- SPEED BOOST SYSTEM (Stolen from BK's Hub)
-- ============================================================

local SpeedBoostConnection = nil
local STEAL_SPEED = 25.5

local function StartSpeedBoost()
    if SpeedBoostConnection then return end
    
    SpeedBoostConnection = RunService.Heartbeat:Connect(function()
        if not Config.SpeedBoostEnabled then return end
        if not LocalPlayer:GetAttribute("Stealing") then return end
        
        local char = LocalPlayer.Character
        if not char then return end
        
        local hum = char:FindFirstChildOfClass("Humanoid")
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if not hum or not hrp then return end
        
        local move = hum.MoveDirection
        if move.Magnitude > 0 then
            hrp.AssemblyLinearVelocity = Vector3.new(
                move.X * STEAL_SPEED,
                hrp.AssemblyLinearVelocity.Y,
                move.Z * STEAL_SPEED
            )
        end
    end)
end

local function StopSpeedBoost()
    if SpeedBoostConnection then
        SpeedBoostConnection:Disconnect()
        SpeedBoostConnection = nil
    end
end

-- ============================================================
-- ANTI-RAGDOLL SYSTEM (Stolen from BK's Hub) - FIXED
-- ============================================================

local AntiRagdollConnection = nil
local cachedCharData = {}

local function CacheCharacterData()
    local char = LocalPlayer.Character
    if not char then return false end
    
    local hum = char:FindFirstChildOfClass("Humanoid")
    local root = char:FindFirstChild("HumanoidRootPart")
    
    if not hum or not root then return false end
    
    cachedCharData = {
        character = char,
        humanoid = hum,
        root = root,
    }
    
    return true
end

local function IsRagdolled()
    if not cachedCharData.humanoid then return false end
    
    local hum = cachedCharData.humanoid
    local state = hum:GetState()
    
    -- State check
    local ragdollStates = {
        [Enum.HumanoidStateType.Physics] = true,
        [Enum.HumanoidStateType.Ragdoll] = true,
        [Enum.HumanoidStateType.FallingDown] = true
    }
    
    if ragdollStates[state] then
        return true
    end
    
    -- Timer attribute check
    local endTime = LocalPlayer:GetAttribute("RagdollEndTime")
    if endTime then
        local now = workspace:GetServerTimeNow()
        if (endTime - now) > 0 then
            return true
        end
    end
    
    return false
end

local function RemoveRagdollConstraints()
    if not cachedCharData.character then return end
    
    for _, descendant in ipairs(cachedCharData.character:GetDescendants()) do
        if descendant:IsA("BallSocketConstraint") or 
           (descendant:IsA("Attachment") and descendant.Name:find("RagdollAttachment")) then
            pcall(function()
                descendant:Destroy()
            end)
        end
    end
end

local function ForceExitRagdoll()
    if not cachedCharData.humanoid or not cachedCharData.root then return end
    
    local hum = cachedCharData.humanoid
    local root = cachedCharData.root
    
    -- Clear ragdoll timer
    pcall(function()
        local now = workspace:GetServerTimeNow()
        LocalPlayer:SetAttribute("RagdollEndTime", now)
    end)
    
    -- Force standing state
    if hum.Health > 0 then
        hum:ChangeState(Enum.HumanoidStateType.Running)
    end
    
    -- Reset physics
    root.Anchored = false
    root.AssemblyLinearVelocity = Vector3.zero
    root.AssemblyAngularVelocity = Vector3.zero
end

local function AntiRagdollLoop()
    while Config.AntiRagdollEnabled and cachedCharData.humanoid do
        task.wait()
        
        if IsRagdolled() then
            -- Remove constraints and force exit
            RemoveRagdollConstraints()
            ForceExitRagdoll()
        end
    end
end

local function SetupCameraBinding()
    if not cachedCharData.humanoid then return end
    
    RunService.RenderStepped:Connect(function()
        if not Config.AntiRagdollEnabled then return end
        
        local cam = workspace.CurrentCamera
        if cam and cachedCharData.humanoid and cam.CameraSubject ~= cachedCharData.humanoid then
            cam.CameraSubject = cachedCharData.humanoid
        end
    end)
end

local function OnCharacterAdded(char)
    task.wait(0.5)
    
    if not Config.AntiRagdollEnabled then return end
    
    if CacheCharacterData() then
        SetupCameraBinding()
        task.spawn(AntiRagdollLoop)
    end
end

local function StartAntiRagdoll()
    if AntiRagdollConnection then return end
    
    -- Cache character data
    if not CacheCharacterData() then
        warn("Failed to cache character data")
        return
    end
    
    -- Setup character respawn listener
    AntiRagdollConnection = LocalPlayer.CharacterAdded:Connect(OnCharacterAdded)
    
    -- Start loop
    SetupCameraBinding()
    task.spawn(AntiRagdollLoop)
    
    print("Anti-Ragdoll started!")
end

local function StopAntiRagdoll()
    Config.AntiRagdollEnabled = false
    
    if AntiRagdollConnection then
        AntiRagdollConnection:Disconnect()
        AntiRagdollConnection = nil
    end
    
    cachedCharData = {}
    print("Anti-Ragdoll stopped!")
end

-- ============================================================
-- FLOOR STEAL SYSTEM (Stolen from BK's Hub)
-- ============================================================

local FloatPlatform = nil

local function StartFloorSteal()
    if FloatPlatform then FloatPlatform:Destroy() end
    
    FloatPlatform = Instance.new("Part")
    FloatPlatform.Size = Vector3.new(6, 1, 6)
    FloatPlatform.Anchored = true
    FloatPlatform.CanCollide = true
    FloatPlatform.Transparency = 1
    FloatPlatform.Parent = workspace
    
    task.spawn(function()
        while Config.FloorStealEnabled and FloatPlatform do
            local char = LocalPlayer.Character
            if char then
                local hrp = char:FindFirstChild("HumanoidRootPart")
                if hrp then
                    FloatPlatform.Position = hrp.Position - Vector3.new(0, 3, 0)
                end
            end
            task.wait(0.05)
        end
    end)
end

local function StopFloorSteal()
    if FloatPlatform then
        FloatPlatform:Destroy()
        FloatPlatform = nil
    end
end

-- ============================================================
-- CREATE GUI ELEMENTS
-- ============================================================

-- Helper function to create BRIGHT visible section headers
local function CreateSection(title)
    local SectionFrame = Instance.new("Frame")
    SectionFrame.Size = UDim2.new(1, 0, 0, 32)
    SectionFrame.BackgroundTransparency = 1
    SectionFrame.Parent = ScrollFrame
    
    local SectionLabel = Instance.new("TextLabel")
    SectionLabel.Size = UDim2.new(1, 0, 1, 0)
    SectionLabel.BackgroundTransparency = 1
    SectionLabel.Text = title
    SectionLabel.TextColor3 = Color3.fromRGB(255, 200, 255)
    SectionLabel.TextSize = 19
    SectionLabel.Font = Enum.Font.GothamBold
    SectionLabel.TextXAlignment = Enum.TextXAlignment.Left
    SectionLabel.TextStrokeTransparency = 0.3
    SectionLabel.TextStrokeColor3 = Color3.fromRGB(180, 80, 255)
    SectionLabel.Parent = SectionFrame
    
    return SectionFrame
end

-- Section: Auto Steal
CreateSection("‚ö° AUTO STEAL")

CreateToggle("Auto-Steal Highest Gen", function(enabled)
    Config.AutoStealEnabled = enabled
    if enabled then
        Config.AutoStealNearest = false
        StartAutoSteal()
    else
        StopAutoSteal()
    end
end)

CreateToggle("Auto-Steal Nearest", function(enabled)
    Config.AutoStealNearest = enabled
    if enabled then
        Config.AutoStealEnabled = true
        StartAutoSteal()
    end
end)

CreateToggle("Speed Boost During Steal", function(enabled)
    Config.SpeedBoostEnabled = enabled
    if enabled then
        StartSpeedBoost()
    else
        StopSpeedBoost()
    end
end)

CreateToggle("AP Spammer", function(enabled)
    if enabled then
        local success, err = pcall(function()
            loadstring(game:HttpGet("https://raw.githubusercontent.com/NicolasKidd08-cloud/kfn/refs/heads/main/SpammerV2", true))()
        end)
        if not success then
            warn("SpammerV2 error:", err)
            game:GetService("StarterGui"):SetCore("SendNotification", {
                Title = "AP Spammer Error";
                Text = "Failed to load script";
                Duration = 3;
            })
        else
            game:GetService("StarterGui"):SetCore("SendNotification", {
                Title = "AP Spammer";
                Text = "Loaded successfully!";
                Duration = 3;
            })
        end
    else
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "AP Spammer";
            Text = "Toggle OFF to stop (reload required)";
            Duration = 3;
        })
    end
end)

-- Section: Movement
CreateSection("üöÄ MOVEMENT")

CreateToggle("Floor Steal", function(enabled)
    Config.FloorStealEnabled = enabled
    if enabled then
        StartFloorSteal()
    else
        StopFloorSteal()
    end
end)

-- Section: Protection
CreateSection("üõ°Ô∏è PROTECTION")

CreateToggle("Desync V3", function(enabled)
    if enabled then
        EnableDesync()
    else
        DisableDesync()
    end
end)

CreateToggle("Anti-Ragdoll", function(enabled)
    Config.AntiRagdollEnabled = enabled
    if enabled then
        StartAntiRagdoll()
    else
        StopAntiRagdoll()
    end
end)

-- Section: Actions
CreateSection("‚öôÔ∏è ACTIONS")

CreateButton("üîÑ Rejoin Server", Color3.fromRGB(100, 150, 255), function()
    game:GetService("TeleportService"):TeleportToPlaceInstance(game.PlaceId, game.JobId, LocalPlayer)
end)

CreateButton("‚ùå Kick Self", Color3.fromRGB(255, 80, 100), function()
    LocalPlayer:Kick("Kicked by user")
end)

-- Update canvas size
UIListLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    ScrollFrame.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y + 10)
end)

-- Startup notification
game:GetService("StarterGui"):SetCore("SendNotification", {
    Title = "‚ö° NEXA HUB";
    Text = "Loaded successfully! All features ready";
    Duration = 5;
})

print("‚ö° NEXA HUB loaded!")
