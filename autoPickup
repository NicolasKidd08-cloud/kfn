--[[
    Modern Brainrot Hub
    Stolen features from BK's Hub v2.5 but with a cleaner UI
]]

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Game modules
local Packages = ReplicatedStorage:WaitForChild("Packages")
local Datas = ReplicatedStorage:WaitForChild("Datas")
local Shared = ReplicatedStorage:WaitForChild("Shared")
local Utils = ReplicatedStorage:WaitForChild("Utils")

local Synchronizer = require(Packages:WaitForChild("Synchronizer"))
local AnimalsData = require(Datas:WaitForChild("Animals"))
local RaritiesData = require(Datas:WaitForChild("Rarities"))
local AnimalsShared = require(Shared:WaitForChild("Animals"))
local NumberUtils = require(Utils:WaitForChild("NumberUtils"))

-- Config
local Config = {
    AutoStealEnabled = false,
    AutoStealNearest = false,
    DesyncEnabled = false,
    ESPEnabled = false,
    AntiRagdollEnabled = false,
    FloorStealEnabled = false,
    SpeedBoostEnabled = false,
}

-- DESYNC FLAGS (Stolen from BK's Hub)
local DESYNC_FLAGS = {
    LargeReplicatorEnabled9 = true,
    GameNetDontSendRedundantNumTimes = 1,
    MaxTimestepMultiplierAcceleration = 2147483647,
    InterpolationFrameVelocityThresholdMillionth = 5,
    CheckPVDifferencesForInterpolationMinRotVelThresholdRadsPerSecHundredth = 1,
    TimestepArbiterVelocityCriteriaThresholdTwoDt = 2147483646,
    GameNetPVHeaderLinearVelocityZeroCutoffExponent = -5000,
    TimestepArbiterHumanoidTurningVelThreshold = 1,
    LargeReplicatorSerializeWrite4 = true,
    SimExplicitlyCappedTimestepMultiplier = 2147483646,
    InterpolationFrameRotVelocityThresholdMillionth = 5,
    ServerMaxBandwith = 52,
}

-- GUI Creation
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ModernBrainrotHub"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.Parent = PlayerGui

-- Main Frame with gradient background
local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 450, 0, 580)
MainFrame.Position = UDim2.new(0.5, -225, 0.5, -290)
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui

-- Rounded corners
local MainCorner = Instance.new("UICorner")
MainCorner.CornerRadius = UDim.new(0, 16)
MainCorner.Parent = MainFrame

-- Gradient overlay
local Gradient = Instance.new("UIGradient")
Gradient.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0, Color3.fromRGB(25, 25, 32)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(15, 15, 20))
})
Gradient.Rotation = 45
Gradient.Parent = MainFrame

-- Glowing border
local MainStroke = Instance.new("UIStroke")
MainStroke.Color = Color3.fromRGB(138, 43, 226)
MainStroke.Thickness = 2
MainStroke.Transparency = 0.3
MainStroke.Parent = MainFrame

-- Animated gradient for stroke
local StrokeGradient = Instance.new("UIGradient")
StrokeGradient.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0, Color3.fromRGB(138, 43, 226)),
    ColorSequenceKeypoint.new(0.5, Color3.fromRGB(255, 85, 255)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(138, 43, 226))
})
StrokeGradient.Parent = MainStroke

-- Animate the stroke gradient
task.spawn(function()
    while MainFrame.Parent do
        for i = 0, 360, 2 do
            if not MainFrame.Parent then break end
            StrokeGradient.Rotation = i
            task.wait(0.03)
        end
    end
end)

-- Drop shadow effect
local Shadow = Instance.new("ImageLabel")
Shadow.Name = "Shadow"
Shadow.Size = UDim2.new(1, 30, 1, 30)
Shadow.Position = UDim2.new(0, -15, 0, -15)
Shadow.BackgroundTransparency = 1
Shadow.Image = "rbxasset://textures/ui/GuiImagePlaceholder.png"
Shadow.ImageColor3 = Color3.fromRGB(0, 0, 0)
Shadow.ImageTransparency = 0.7
Shadow.ScaleType = Enum.ScaleType.Slice
Shadow.SliceCenter = Rect.new(10, 10, 118, 118)
Shadow.ZIndex = 0
Shadow.Parent = MainFrame

-- Header container with glass effect
local HeaderFrame = Instance.new("Frame")
HeaderFrame.Size = UDim2.new(1, 0, 0, 80)
HeaderFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 38)
HeaderFrame.BackgroundTransparency = 0.3
HeaderFrame.BorderSizePixel = 0
HeaderFrame.Parent = MainFrame

Instance.new("UICorner", HeaderFrame).CornerRadius = UDim.new(0, 16)

-- Header gradient
local HeaderGradient = Instance.new("UIGradient")
HeaderGradient.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0, Color3.fromRGB(35, 35, 45)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(25, 25, 35))
})
HeaderGradient.Rotation = 90
HeaderGradient.Parent = HeaderFrame

-- Title with glow effect
local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, -30, 0, 35)
Title.Position = UDim2.new(0, 20, 0, 15)
Title.BackgroundTransparency = 1
Title.Text = "üß† Modern Brainrot Hub"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = 24
Title.Font = Enum.Font.GothamBold
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.TextStrokeTransparency = 0.8
Title.TextStrokeColor3 = Color3.fromRGB(138, 43, 226)
Title.Parent = HeaderFrame

-- Title gradient
local TitleGradient = Instance.new("UIGradient")
TitleGradient.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 255, 255)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(200, 150, 255))
})
TitleGradient.Parent = Title

-- Subtitle with fade
local Subtitle = Instance.new("TextLabel")
Subtitle.Size = UDim2.new(1, -30, 0, 20)
Subtitle.Position = UDim2.new(0, 20, 0, 50)
Subtitle.BackgroundTransparency = 1
Subtitle.Text = "Premium Edition ‚Ä¢ All Features Unlocked"
Subtitle.TextColor3 = Color3.fromRGB(160, 160, 180)
Subtitle.TextSize = 13
Subtitle.Font = Enum.Font.Gotham
Subtitle.TextXAlignment = Enum.TextXAlignment.Left
Subtitle.TextTransparency = 0.3
Subtitle.Parent = HeaderFrame

-- Status indicator
local StatusDot = Instance.new("Frame")
StatusDot.Size = UDim2.new(0, 8, 0, 8)
StatusDot.Position = UDim2.new(1, -20, 0, 28)
StatusDot.BackgroundColor3 = Color3.fromRGB(0, 255, 150)
StatusDot.BorderSizePixel = 0
StatusDot.Parent = HeaderFrame

Instance.new("UICorner", StatusDot).CornerRadius = UDim.new(1, 0)

-- Pulse animation for status dot
task.spawn(function()
    while StatusDot.Parent do
        TweenService:Create(StatusDot, TweenInfo.new(0.8, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), {
            BackgroundTransparency = 0.5
        }):Play()
        task.wait(0.8)
        TweenService:Create(StatusDot, TweenInfo.new(0.8, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), {
            BackgroundTransparency = 0
        }):Play()
        task.wait(0.8)
    end
end)

-- Scroll Frame with custom styling
local ScrollFrame = Instance.new("ScrollingFrame")
ScrollFrame.Size = UDim2.new(1, -30, 1, -110)
ScrollFrame.Position = UDim2.new(0, 15, 0, 95)
ScrollFrame.BackgroundTransparency = 1
ScrollFrame.BorderSizePixel = 0
ScrollFrame.ScrollBarThickness = 4
ScrollFrame.ScrollBarImageColor3 = Color3.fromRGB(138, 43, 226)
ScrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
ScrollFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
ScrollFrame.ScrollingDirection = Enum.ScrollingDirection.Y
ScrollFrame.Parent = MainFrame

-- Custom scrollbar
local ScrollBarCorner = Instance.new("UICorner")
ScrollBarCorner.CornerRadius = UDim.new(1, 0)

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.Padding = UDim.new(0, 12)
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Parent = ScrollFrame

-- Helper function to create toggles with professional styling
local function CreateToggle(name, callback)
    local ToggleFrame = Instance.new("Frame")
    ToggleFrame.Size = UDim2.new(1, 0, 0, 55)
    ToggleFrame.BackgroundColor3 = Color3.fromRGB(28, 28, 35)
    ToggleFrame.BackgroundTransparency = 0.4
    ToggleFrame.BorderSizePixel = 0
    ToggleFrame.Parent = ScrollFrame
    
    local ToggleCorner = Instance.new("UICorner")
    ToggleCorner.CornerRadius = UDim.new(0, 12)
    ToggleCorner.Parent = ToggleFrame
    
    -- Glass effect
    local ToggleGradient = Instance.new("UIGradient")
    ToggleGradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(35, 35, 45)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(28, 28, 35))
    })
    ToggleGradient.Rotation = 90
    ToggleGradient.Parent = ToggleFrame
    
    -- Subtle border
    local ToggleBorder = Instance.new("UIStroke")
    ToggleBorder.Color = Color3.fromRGB(60, 60, 75)
    ToggleBorder.Thickness = 1
    ToggleBorder.Transparency = 0.5
    ToggleBorder.Parent = ToggleFrame
    
    -- Icon (optional decorative element)
    local Icon = Instance.new("Frame")
    Icon.Size = UDim2.new(0, 6, 0, 6)
    Icon.Position = UDim2.new(0, 15, 0.5, -3)
    Icon.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
    Icon.BorderSizePixel = 0
    Icon.Parent = ToggleFrame
    
    Instance.new("UICorner", Icon).CornerRadius = UDim.new(1, 0)
    
    -- Label with gradient
    local Label = Instance.new("TextLabel")
    Label.Size = UDim2.new(0.65, 0, 1, 0)
    Label.Position = UDim2.new(0, 30, 0, 0)
    Label.BackgroundTransparency = 1
    Label.Text = name
    Label.TextColor3 = Color3.fromRGB(255, 255, 255)
    Label.TextSize = 15
    Label.Font = Enum.Font.GothamBold
    Label.TextXAlignment = Enum.TextXAlignment.Left
    Label.Parent = ToggleFrame
    
    local LabelGradient = Instance.new("UIGradient")
    LabelGradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 255, 255)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(220, 220, 240))
    })
    LabelGradient.Parent = Label
    
    -- Modern toggle switch container
    local ToggleBg = Instance.new("Frame")
    ToggleBg.Size = UDim2.new(0, 54, 0, 30)
    ToggleBg.Position = UDim2.new(1, -65, 0.5, -15)
    ToggleBg.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
    ToggleBg.BorderSizePixel = 0
    ToggleBg.Parent = ToggleFrame
    
    Instance.new("UICorner", ToggleBg).CornerRadius = UDim.new(1, 0)
    
    -- Toggle gradient
    local ToggleBgGradient = Instance.new("UIGradient")
    ToggleBgGradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(50, 50, 60)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(40, 40, 50))
    })
    ToggleBgGradient.Rotation = 90
    ToggleBgGradient.Parent = ToggleBg
    
    -- Inner shadow
    local ToggleShadow = Instance.new("UIStroke")
    ToggleShadow.Color = Color3.fromRGB(20, 20, 25)
    ToggleShadow.Thickness = 2
    ToggleShadow.Transparency = 0.8
    ToggleShadow.Parent = ToggleBg
    
    -- Toggle circle
    local ToggleCircle = Instance.new("Frame")
    ToggleCircle.Size = UDim2.new(0, 24, 0, 24)
    ToggleCircle.Position = UDim2.new(0, 3, 0.5, -12)
    ToggleCircle.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    ToggleCircle.BorderSizePixel = 0
    ToggleCircle.Parent = ToggleBg
    
    Instance.new("UICorner", ToggleCircle).CornerRadius = UDim.new(1, 0)
    
    -- Circle shadow
    local CircleStroke = Instance.new("UIStroke")
    CircleStroke.Color = Color3.fromRGB(100, 100, 120)
    CircleStroke.Thickness = 1
    CircleStroke.Transparency = 0.5
    CircleStroke.Parent = ToggleCircle
    
    local Button = Instance.new("TextButton")
    Button.Size = UDim2.new(1, 0, 1, 0)
    Button.BackgroundTransparency = 1
    Button.Text = ""
    Button.Parent = ToggleFrame
    
    local enabled = false
    
    -- Hover effect
    Button.MouseEnter:Connect(function()
        TweenService:Create(ToggleFrame, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {
            BackgroundTransparency = 0.2
        }):Play()
        TweenService:Create(ToggleBorder, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {
            Transparency = 0.3
        }):Play()
    end)
    
    Button.MouseLeave:Connect(function()
        TweenService:Create(ToggleFrame, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {
            BackgroundTransparency = 0.4
        }):Play()
        TweenService:Create(ToggleBorder, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {
            Transparency = 0.5
        }):Play()
    end)
    
    Button.MouseButton1Click:Connect(function()
        enabled = not enabled
        callback(enabled)
        
        -- Animate toggle background
        TweenService:Create(ToggleBg, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            BackgroundColor3 = enabled and Color3.fromRGB(138, 43, 226) or Color3.fromRGB(45, 45, 55)
        }):Play()
        
        TweenService:Create(ToggleBgGradient, TweenInfo.new(0.3, Enum.EasingStyle.Quad), {
            Color = enabled and ColorSequence.new({
                ColorSequenceKeypoint.new(0, Color3.fromRGB(160, 60, 255)),
                ColorSequenceKeypoint.new(1, Color3.fromRGB(120, 30, 200))
            }) or ColorSequence.new({
                ColorSequenceKeypoint.new(0, Color3.fromRGB(50, 50, 60)),
                ColorSequenceKeypoint.new(1, Color3.fromRGB(40, 40, 50))
            })
        }):Play()
        
        -- Animate circle
        TweenService:Create(ToggleCircle, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            Position = enabled and UDim2.new(0, 27, 0.5, -12) or UDim2.new(0, 3, 0.5, -12),
            BackgroundColor3 = enabled and Color3.fromRGB(255, 255, 255) or Color3.fromRGB(200, 200, 210)
        }):Play()
        
        -- Animate icon
        TweenService:Create(Icon, TweenInfo.new(0.3, Enum.EasingStyle.Quad), {
            BackgroundColor3 = enabled and Color3.fromRGB(0, 255, 150) or Color3.fromRGB(138, 43, 226)
        }):Play()
        
        -- Quick scale animation for feedback
        local originalSize = ToggleCircle.Size
        TweenService:Create(ToggleCircle, TweenInfo.new(0.1, Enum.EasingStyle.Quad), {
            Size = UDim2.new(0, 20, 0, 20)
        }):Play()
        task.wait(0.1)
        TweenService:Create(ToggleCircle, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {
            Size = originalSize
        }):Play()
    end)
    
    return ToggleFrame
end

-- Helper function for action buttons with premium styling
local function CreateButton(name, color, callback)
    local ButtonFrame = Instance.new("TextButton")
    ButtonFrame.Size = UDim2.new(1, 0, 0, 50)
    ButtonFrame.BackgroundColor3 = color
    ButtonFrame.BackgroundTransparency = 0.2
    ButtonFrame.BorderSizePixel = 0
    ButtonFrame.Text = ""
    ButtonFrame.AutoButtonColor = false
    ButtonFrame.Parent = ScrollFrame
    
    local ButtonCorner = Instance.new("UICorner")
    ButtonCorner.CornerRadius = UDim.new(0, 12)
    ButtonCorner.Parent = ButtonFrame
    
    -- Gradient overlay
    local ButtonGradient = Instance.new("UIGradient")
    local baseColor = color
    ButtonGradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(
            math.min(baseColor.R * 255 + 20, 255),
            math.min(baseColor.G * 255 + 20, 255),
            math.min(baseColor.B * 255 + 20, 255)
        )),
        ColorSequenceKeypoint.new(1, baseColor)
    })
    ButtonGradient.Rotation = 90
    ButtonGradient.Parent = ButtonFrame
    
    -- Subtle border
    local ButtonStroke = Instance.new("UIStroke")
    ButtonStroke.Color = Color3.fromRGB(255, 255, 255)
    ButtonStroke.Thickness = 1
    ButtonStroke.Transparency = 0.8
    ButtonStroke.Parent = ButtonFrame
    
    -- Button text with shadow
    local ButtonText = Instance.new("TextLabel")
    ButtonText.Size = UDim2.new(1, -20, 1, 0)
    ButtonText.Position = UDim2.new(0, 10, 0, 0)
    ButtonText.BackgroundTransparency = 1
    ButtonText.Text = name
    ButtonText.TextColor3 = Color3.fromRGB(255, 255, 255)
    ButtonText.TextSize = 15
    ButtonText.Font = Enum.Font.GothamBold
    ButtonText.TextXAlignment = Enum.TextXAlignment.Center
    ButtonText.TextStrokeTransparency = 0.8
    ButtonText.Parent = ButtonFrame
    
    -- Shine effect overlay
    local Shine = Instance.new("Frame")
    Shine.Size = UDim2.new(0, 0, 1, 0)
    Shine.Position = UDim2.new(0, 0, 0, 0)
    Shine.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    Shine.BackgroundTransparency = 0.8
    Shine.BorderSizePixel = 0
    Shine.ZIndex = 2
    Shine.Parent = ButtonFrame
    
    Instance.new("UICorner", Shine).CornerRadius = UDim.new(0, 12)
    
    -- Hover effects
    ButtonFrame.MouseEnter:Connect(function()
        TweenService:Create(ButtonFrame, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {
            BackgroundTransparency = 0
        }):Play()
        TweenService:Create(ButtonStroke, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {
            Transparency = 0.5
        }):Play()
        TweenService:Create(ButtonText, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {
            TextSize = 16
        }):Play()
    end)
    
    ButtonFrame.MouseLeave:Connect(function()
        TweenService:Create(ButtonFrame, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {
            BackgroundTransparency = 0.2
        }):Play()
        TweenService:Create(ButtonStroke, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {
            Transparency = 0.8
        }):Play()
        TweenService:Create(ButtonText, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {
            TextSize = 15
        }):Play()
    end)
    
    -- Click animation
    ButtonFrame.MouseButton1Click:Connect(function()
        -- Shine animation
        Shine.Size = UDim2.new(0, 0, 1, 0)
        Shine.Position = UDim2.new(0, 0, 0, 0)
        TweenService:Create(Shine, TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            Size = UDim2.new(1, 0, 1, 0),
            Position = UDim2.new(0, 0, 0, 0),
            BackgroundTransparency = 1
        }):Play()
        
        -- Scale animation
        TweenService:Create(ButtonFrame, TweenInfo.new(0.1, Enum.EasingStyle.Quad), {
            Size = UDim2.new(1, -4, 0, 48)
        }):Play()
        task.wait(0.1)
        TweenService:Create(ButtonFrame, TweenInfo.new(0.1, Enum.EasingStyle.Quad), {
            Size = UDim2.new(1, 0, 0, 50)
        }):Play()
        
        callback()
    end)
    
    return ButtonFrame
end

-- ============================================================
-- DESYNC SYSTEM (Stolen from BK's Hub) - TOGGLEABLE
-- ============================================================

local DesyncIndicator = nil
local OriginalFlags = {}

local function EnableDesync()
    if Config.DesyncEnabled then return end
    
    Config.DesyncEnabled = true
    
    -- Store original flags
    for key, value in pairs(DESYNC_FLAGS) do
        pcall(function()
            local success, original = pcall(function()
                return getfflag(tostring(key))
            end)
            if success then
                OriginalFlags[key] = original
            end
        end)
    end
    
    -- Apply desync flags
    for key, value in pairs(DESYNC_FLAGS) do
        pcall(function()
            setfflag(tostring(key), tostring(value))
        end)
    end
    
    -- Create indicator
    DesyncIndicator = Instance.new("Frame")
    DesyncIndicator.Size = UDim2.new(0, 200, 0, 50)
    DesyncIndicator.Position = UDim2.new(0.5, -100, 0, 100)
    DesyncIndicator.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
    DesyncIndicator.BorderSizePixel = 0
    DesyncIndicator.Parent = ScreenGui
    
    Instance.new("UICorner", DesyncIndicator).CornerRadius = UDim.new(0, 10)
    
    local IndicatorStroke = Instance.new("UIStroke")
    IndicatorStroke.Color = Color3.fromRGB(138, 43, 226)
    IndicatorStroke.Thickness = 2
    IndicatorStroke.Parent = DesyncIndicator
    
    local IndicatorText = Instance.new("TextLabel")
    IndicatorText.Size = UDim2.new(1, 0, 1, 0)
    IndicatorText.BackgroundTransparency = 1
    IndicatorText.Text = "‚ö° DESYNC V3 ACTIVE"
    IndicatorText.TextColor3 = Color3.fromRGB(138, 43, 226)
    IndicatorText.TextSize = 14
    IndicatorText.Font = Enum.Font.GothamBold
    IndicatorText.Parent = DesyncIndicator
    
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "Desync Enabled";
        Text = "No lagback active";
        Duration = 3;
    })
end

local function DisableDesync()
    if not Config.DesyncEnabled then return end
    
    Config.DesyncEnabled = false
    
    -- Restore original flags
    for key, original in pairs(OriginalFlags) do
        pcall(function()
            setfflag(tostring(key), tostring(original))
        end)
    end
    
    OriginalFlags = {}
    
    -- Remove indicator
    if DesyncIndicator then
        DesyncIndicator:Destroy()
        DesyncIndicator = nil
    end
    
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "Desync Disabled";
        Text = "Flags restored";
        Duration = 3;
    })
end

-- ============================================================
-- AUTO STEAL SYSTEM (Stolen from BK's Hub) - FIXED WITH ANIMAL SCANNING
-- ============================================================

local PromptCache = {}
local InternalStealCache = {}
local AllAnimalsCache = {}

local function GetHRP()
    local char = LocalPlayer.Character
    if not char then return nil end
    return char:FindFirstChild("HumanoidRootPart")
end

local function IsMyBaseAnimal(animalData)
    if not animalData or not animalData.plot then
        return false
    end
    
    local plots = workspace:FindFirstChild("Plots")
    if not plots then
        return false
    end
    
    local plot = plots:FindFirstChild(animalData.plot)
    if not plot then
        return false
    end
    
    -- Use Synchronizer to check owner
    local channel = Synchronizer:Get(plot.Name)
    if channel then
        local owner = channel:Get("Owner")
        if owner then
            if typeof(owner) == "Instance" and owner:IsA("Player") then
                return owner.UserId == LocalPlayer.UserId
            elseif typeof(owner) == "table" and owner.UserId then
                return owner.UserId == LocalPlayer.UserId
            elseif typeof(owner) == "Instance" then
                return owner == LocalPlayer
            end
        end
    end
    
    return false
end

local function ScanAllAnimals()
    AllAnimalsCache = {}
    
    local plots = workspace:FindFirstChild("Plots")
    if not plots then return end
    
    for _, plot in ipairs(plots:GetChildren()) do
        local channel = Synchronizer:Get(plot.Name)
        if not channel then continue end
        
        local animalList = channel:Get("AnimalList")
        if not animalList then continue end
        
        local owner = channel:Get("Owner")
        if not owner or not Players:FindFirstChild(owner.Name) then continue end
        
        for slot, animalData in pairs(animalList) do
            if type(animalData) == "table" then
                local animalName = animalData.Index
                local animalInfo = AnimalsData[animalName]
                if not animalInfo then continue end
                
                local mutation = animalData.Mutation or "None"
                local traits = animalData.Traits or {}
                
                local genValue = AnimalsShared:GetGeneration(animalName, animalData.Mutation, animalData.Traits, nil)
                
                local data = {
                    name = animalInfo.DisplayName or animalName,
                    genValue = genValue,
                    owner = owner.Name,
                    plot = plot.Name,
                    slot = tostring(slot),
                    uid = plot.Name .. "_" .. tostring(slot),
                }
                
                -- Don't add your own base animals
                if not IsMyBaseAnimal(data) then
                    table.insert(AllAnimalsCache, data)
                end
            end
        end
    end
    
    -- Sort by gen value (highest first)
    table.sort(AllAnimalsCache, function(a, b)
        return a.genValue > b.genValue
    end)
end

local function GetAnimalPosition(animalData)
    local plots = workspace:FindFirstChild("Plots")
    if not plots then return nil end
    
    local plot = plots:FindFirstChild(animalData.plot)
    if not plot then return nil end
    
    local podiums = plot:FindFirstChild("AnimalPodiums")
    if not podiums then return nil end
    
    local podium = podiums:FindFirstChild(animalData.slot)
    if not podium then return nil end
    
    return podium:GetPivot().Position
end

local function GetNearestAnimal()
    local hrp = GetHRP()
    if not hrp then return nil end
    
    local nearest = nil
    local minDist = math.huge
    
    for _, animalData in ipairs(AllAnimalsCache) do
        local pos = GetAnimalPosition(animalData)
        if pos then
            local dist = (hrp.Position - pos).Magnitude
            
            if dist < minDist then
                minDist = dist
                nearest = animalData
            end
        end
    end
    
    return nearest
end

local function FindProximityPromptForAnimal(animalData)
    if not animalData then return nil end
    
    -- Check cache
    local cachedPrompt = PromptCache[animalData.uid]
    if cachedPrompt and cachedPrompt.Parent then
        return cachedPrompt
    end
    
    local plots = workspace:FindFirstChild("Plots")
    if not plots then return nil end
    
    local plot = plots:FindFirstChild(animalData.plot)
    if not plot then return nil end
    
    local podiums = plot:FindFirstChild("AnimalPodiums")
    if not podiums then return nil end
    
    local podium = podiums:FindFirstChild(animalData.slot)
    if not podium then return nil end
    
    local base = podium:FindFirstChild("Base")
    if not base then return nil end
    
    local spawn = base:FindFirstChild("Spawn")
    if not spawn then return nil end
    
    local attach = spawn:FindFirstChild("PromptAttachment")
    if not attach then return nil end
    
    for _, p in ipairs(attach:GetChildren()) do
        if p:IsA("ProximityPrompt") then
            PromptCache[animalData.uid] = p
            return p
        end
    end
    
    return nil
end

local function BuildStealCallbacks(prompt)
    if InternalStealCache[prompt] then return end
    
    local data = {
        holdCallbacks = {},
        triggerCallbacks = {},
        ready = true,
    }
    
    local ok1, conns1 = pcall(getconnections, prompt.PromptButtonHoldBegan)
    if ok1 and type(conns1) == "table" then
        for _, conn in ipairs(conns1) do
            if type(conn.Function) == "function" then
                table.insert(data.holdCallbacks, conn.Function)
            end
        end
    end
    
    local ok2, conns2 = pcall(getconnections, prompt.Triggered)
    if ok2 and type(conns2) == "table" then
        for _, conn in ipairs(conns2) do
            if type(conn.Function) == "function" then
                table.insert(data.triggerCallbacks, conn.Function)
            end
        end
    end
    
    if #data.holdCallbacks > 0 or #data.triggerCallbacks > 0 then
        InternalStealCache[prompt] = data
    end
end

local function ExecuteSteal(prompt)
    local data = InternalStealCache[prompt]
    if not data or not data.ready then return false end
    
    data.ready = false
    
    task.spawn(function()
        -- Execute hold callbacks
        for _, fn in ipairs(data.holdCallbacks) do
            task.spawn(fn)
        end
        
        task.wait(1.3)
        
        -- Execute trigger callbacks
        for _, fn in ipairs(data.triggerCallbacks) do
            task.spawn(fn)
        end
        
        task.wait(0.1)
        data.ready = true
    end)
    
    return true
end

local AutoStealConnection = nil
local LastScanTime = 0

local function StartAutoSteal()
    if AutoStealConnection then return end
    
    -- Initial scan
    ScanAllAnimals()
    
    AutoStealConnection = RunService.Heartbeat:Connect(function()
        if not Config.AutoStealEnabled then return end
        
        -- Rescan every 5 seconds
        local now = tick()
        if now - LastScanTime >= 5 then
            ScanAllAnimals()
            LastScanTime = now
        end
        
        local targetAnimal = nil
        
        if Config.AutoStealNearest then
            targetAnimal = GetNearestAnimal()
        else
            -- Get highest gen (first in sorted list)
            targetAnimal = AllAnimalsCache[1]
        end
        
        if not targetAnimal then return end
        
        -- Find proximity prompt
        local prompt = FindProximityPromptForAnimal(targetAnimal)
        
        if prompt then
            -- Build callbacks if not cached
            if not InternalStealCache[prompt] then
                BuildStealCallbacks(prompt)
            end
            
            -- Execute steal
            ExecuteSteal(prompt)
        end
    end)
    
    print("Auto-Steal started! Found " .. #AllAnimalsCache .. " animals")
end

local function StopAutoSteal()
    if AutoStealConnection then
        AutoStealConnection:Disconnect()
        AutoStealConnection = nil
    end
    print("Auto-Steal stopped!")
end

-- ============================================================
-- SPEED BOOST SYSTEM (Stolen from BK's Hub)
-- ============================================================

local SpeedBoostConnection = nil
local STEAL_SPEED = 25.5

local function StartSpeedBoost()
    if SpeedBoostConnection then return end
    
    SpeedBoostConnection = RunService.Heartbeat:Connect(function()
        if not Config.SpeedBoostEnabled then return end
        if not LocalPlayer:GetAttribute("Stealing") then return end
        
        local char = LocalPlayer.Character
        if not char then return end
        
        local hum = char:FindFirstChildOfClass("Humanoid")
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if not hum or not hrp then return end
        
        local move = hum.MoveDirection
        if move.Magnitude > 0 then
            hrp.AssemblyLinearVelocity = Vector3.new(
                move.X * STEAL_SPEED,
                hrp.AssemblyLinearVelocity.Y,
                move.Z * STEAL_SPEED
            )
        end
    end)
end

local function StopSpeedBoost()
    if SpeedBoostConnection then
        SpeedBoostConnection:Disconnect()
        SpeedBoostConnection = nil
    end
end

-- ============================================================
-- ANTI-RAGDOLL SYSTEM (Stolen from BK's Hub) - FIXED
-- ============================================================

local AntiRagdollConnection = nil
local cachedCharData = {}

local function CacheCharacterData()
    local char = LocalPlayer.Character
    if not char then return false end
    
    local hum = char:FindFirstChildOfClass("Humanoid")
    local root = char:FindFirstChild("HumanoidRootPart")
    
    if not hum or not root then return false end
    
    cachedCharData = {
        character = char,
        humanoid = hum,
        root = root,
    }
    
    return true
end

local function IsRagdolled()
    if not cachedCharData.humanoid then return false end
    
    local hum = cachedCharData.humanoid
    local state = hum:GetState()
    
    -- State check
    local ragdollStates = {
        [Enum.HumanoidStateType.Physics] = true,
        [Enum.HumanoidStateType.Ragdoll] = true,
        [Enum.HumanoidStateType.FallingDown] = true
    }
    
    if ragdollStates[state] then
        return true
    end
    
    -- Timer attribute check
    local endTime = LocalPlayer:GetAttribute("RagdollEndTime")
    if endTime then
        local now = workspace:GetServerTimeNow()
        if (endTime - now) > 0 then
            return true
        end
    end
    
    return false
end

local function RemoveRagdollConstraints()
    if not cachedCharData.character then return end
    
    for _, descendant in ipairs(cachedCharData.character:GetDescendants()) do
        if descendant:IsA("BallSocketConstraint") or 
           (descendant:IsA("Attachment") and descendant.Name:find("RagdollAttachment")) then
            pcall(function()
                descendant:Destroy()
            end)
        end
    end
end

local function ForceExitRagdoll()
    if not cachedCharData.humanoid or not cachedCharData.root then return end
    
    local hum = cachedCharData.humanoid
    local root = cachedCharData.root
    
    -- Clear ragdoll timer
    pcall(function()
        local now = workspace:GetServerTimeNow()
        LocalPlayer:SetAttribute("RagdollEndTime", now)
    end)
    
    -- Force standing state
    if hum.Health > 0 then
        hum:ChangeState(Enum.HumanoidStateType.Running)
    end
    
    -- Reset physics
    root.Anchored = false
    root.AssemblyLinearVelocity = Vector3.zero
    root.AssemblyAngularVelocity = Vector3.zero
end

local function AntiRagdollLoop()
    while Config.AntiRagdollEnabled and cachedCharData.humanoid do
        task.wait()
        
        if IsRagdolled() then
            -- Remove constraints and force exit
            RemoveRagdollConstraints()
            ForceExitRagdoll()
        end
    end
end

local function SetupCameraBinding()
    if not cachedCharData.humanoid then return end
    
    RunService.RenderStepped:Connect(function()
        if not Config.AntiRagdollEnabled then return end
        
        local cam = workspace.CurrentCamera
        if cam and cachedCharData.humanoid and cam.CameraSubject ~= cachedCharData.humanoid then
            cam.CameraSubject = cachedCharData.humanoid
        end
    end)
end

local function OnCharacterAdded(char)
    task.wait(0.5)
    
    if not Config.AntiRagdollEnabled then return end
    
    if CacheCharacterData() then
        SetupCameraBinding()
        task.spawn(AntiRagdollLoop)
    end
end

local function StartAntiRagdoll()
    if AntiRagdollConnection then return end
    
    -- Cache character data
    if not CacheCharacterData() then
        warn("Failed to cache character data")
        return
    end
    
    -- Setup character respawn listener
    AntiRagdollConnection = LocalPlayer.CharacterAdded:Connect(OnCharacterAdded)
    
    -- Start loop
    SetupCameraBinding()
    task.spawn(AntiRagdollLoop)
    
    print("Anti-Ragdoll started!")
end

local function StopAntiRagdoll()
    Config.AntiRagdollEnabled = false
    
    if AntiRagdollConnection then
        AntiRagdollConnection:Disconnect()
        AntiRagdollConnection = nil
    end
    
    cachedCharData = {}
    print("Anti-Ragdoll stopped!")
end

-- ============================================================
-- FLOOR STEAL SYSTEM (Stolen from BK's Hub)
-- ============================================================

local FloatPlatform = nil

local function StartFloorSteal()
    if FloatPlatform then FloatPlatform:Destroy() end
    
    FloatPlatform = Instance.new("Part")
    FloatPlatform.Size = Vector3.new(6, 1, 6)
    FloatPlatform.Anchored = true
    FloatPlatform.CanCollide = true
    FloatPlatform.Transparency = 1
    FloatPlatform.Parent = workspace
    
    task.spawn(function()
        while Config.FloorStealEnabled and FloatPlatform do
            local char = LocalPlayer.Character
            if char then
                local hrp = char:FindFirstChild("HumanoidRootPart")
                if hrp then
                    FloatPlatform.Position = hrp.Position - Vector3.new(0, 3, 0)
                end
            end
            task.wait(0.05)
        end
    end)
end

local function StopFloorSteal()
    if FloatPlatform then
        FloatPlatform:Destroy()
        FloatPlatform = nil
    end
end

-- ============================================================
-- CREATE GUI ELEMENTS
-- ============================================================

-- Helper function to create section headers
local function CreateSection(title)
    local SectionFrame = Instance.new("Frame")
    SectionFrame.Size = UDim2.new(1, 0, 0, 35)
    SectionFrame.BackgroundTransparency = 1
    SectionFrame.Parent = ScrollFrame
    
    local SectionLine = Instance.new("Frame")
    SectionLine.Size = UDim2.new(0, 3, 1, -10)
    SectionLine.Position = UDim2.new(0, 0, 0, 5)
    SectionLine.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
    SectionLine.BorderSizePixel = 0
    SectionLine.Parent = SectionFrame
    
    Instance.new("UICorner", SectionLine).CornerRadius = UDim.new(1, 0)
    
    local SectionGradient = Instance.new("UIGradient")
    SectionGradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(138, 43, 226)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 85, 255))
    })
    SectionGradient.Rotation = 90
    SectionGradient.Parent = SectionLine
    
    local SectionLabel = Instance.new("TextLabel")
    SectionLabel.Size = UDim2.new(1, -15, 1, 0)
    SectionLabel.Position = UDim2.new(0, 15, 0, 0)
    SectionLabel.BackgroundTransparency = 1
    SectionLabel.Text = title
    SectionLabel.TextColor3 = Color3.fromRGB(138, 43, 226)
    SectionLabel.TextSize = 17
    SectionLabel.Font = Enum.Font.GothamBold
    SectionLabel.TextXAlignment = Enum.TextXAlignment.Left
    SectionLabel.TextStrokeTransparency = 0.8
    SectionLabel.TextStrokeColor3 = Color3.fromRGB(138, 43, 226)
    SectionLabel.Parent = SectionFrame
    
    local LabelGradient = Instance.new("UIGradient")
    LabelGradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(138, 43, 226)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(200, 100, 255))
    })
    LabelGradient.Parent = SectionLabel
    
    return SectionFrame
end

-- Section: Auto Steal
CreateSection("‚ö° AUTO STEAL")

CreateToggle("Auto-Steal Highest Gen", function(enabled)
    Config.AutoStealEnabled = enabled
    if enabled then
        Config.AutoStealNearest = false
        StartAutoSteal()
    else
        StopAutoSteal()
    end
end)

CreateToggle("Auto-Steal Nearest", function(enabled)
    Config.AutoStealNearest = enabled
    if enabled then
        Config.AutoStealEnabled = true
        StartAutoSteal()
    end
end)

CreateToggle("Speed Boost During Steal", function(enabled)
    Config.SpeedBoostEnabled = enabled
    if enabled then
        StartSpeedBoost()
    else
        StopSpeedBoost()
    end
end)

-- Section: Movement
CreateSection("üöÄ MOVEMENT")

CreateToggle("Floor Steal", function(enabled)
    Config.FloorStealEnabled = enabled
    if enabled then
        StartFloorSteal()
    else
        StopFloorSteal()
    end
end)

-- Section: Protection
CreateSection("üõ°Ô∏è PROTECTION")

CreateToggle("Desync V3", function(enabled)
    if enabled then
        EnableDesync()
    else
        DisableDesync()
    end
end)

CreateToggle("Anti-Ragdoll", function(enabled)
    Config.AntiRagdollEnabled = enabled
    if enabled then
        StartAntiRagdoll()
    else
        StopAntiRagdoll()
    end
end)

-- Section: Actions
CreateSection("‚öôÔ∏è ACTIONS")

CreateButton("üîÑ Rejoin Server", Color3.fromRGB(100, 150, 255), function()
    game:GetService("TeleportService"):TeleportToPlaceInstance(game.PlaceId, game.JobId, LocalPlayer)
end)

CreateButton("‚ùå Kick Self", Color3.fromRGB(255, 80, 100), function()
    LocalPlayer:Kick("Kicked by user")
end)

-- Update canvas size
UIListLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    ScrollFrame.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y + 10)
end)

-- Startup notification
game:GetService("StarterGui"):SetCore("SendNotification", {
    Title = "Modern Brainrot Hub";
    Text = "Loaded successfully! All features stolen from Nexa Hub";
    Duration = 5;
})

print("üß† Modern Brainrot Hub loaded!")
